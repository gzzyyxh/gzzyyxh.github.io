

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="YOLOv3模型论文及原理详解">
  <meta name="author" content="游隼">
  <meta name="keywords" content="">
  
  <title>YOLOv3: An Incremental Improvement - 游隼</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"gzzyyxh.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>丰之余</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-comment"></i>
                留言板
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="YOLOv3: An Incremental Improvement">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-05-02 00:42" pubdate>
        2021年5月2日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      177
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">YOLOv3: An Incremental Improvement</h1>
            
            <div class="markdown-body">
              <p>YOLOv3模型论文及原理详解</p>
<span id="more"></span>


	<div class="row">
    <embed src="./YOLOv3.pdf" width="100%" height="550" type="application/pdf">
	</div>



<p>YOLO是一种端到端的目标检测模型。YOLO算法的基本思想是：首先通过特征提取网络提取输入特征，得到特定大小的特征图输出。输入图像分成13×13的网格单元，接着如果真实框中某个对象的中心坐标落在某个网格中，那么就由该网格来预测该对象。每个对象有固定数量的边界框，YOLO v3中有三个边界框，使用逻辑回归确定用来预测的回归框.</p>
<h1 id="YOLO结构"><a href="#YOLO结构" class="headerlink" title="YOLO结构"></a>YOLO结构</h1><p>Yolo v3整个结构，不包括池化层和全连接层。Yolo主干结构是Darknet-53网络，还有 Yolo预测支路采用的都是全卷积的结构。</p>
<p><img src="/img/5.2/1.png" srcset="/img/loading.gif" lazyload alt="YOLO v3 结构图"></p>
<p>DBL是YOLO v3的基本组件, 主干网络中使用5个resn结构,n代表数字,表示这个给res_block里含有n个res_unit.YOLO v3在YOLO v2 的基础上开始借鉴ResNet 残差网络结构,这种结构可以让网络结构更深。</p>
<p>在预测支路上有张量拼接（concat）操作。其实现方法是将darknet中间层和中间层后某一层的上采样进行拼接。值得注意的是，张量拼接和Res_unit结构的add的操作是不一样的，张量拼接会扩充张量的维度，而add只是直接相加不会导致张量维度的改变。</p>
<h1 id="Darknet-53-特征提取网络"><a href="#Darknet-53-特征提取网络" class="headerlink" title="Darknet-53 特征提取网络"></a>Darknet-53 特征提取网络</h1><p>Yolo v3中使用了一个53层的卷积网络，这个网络由残差单元叠加而成。Joseph Redmon的实验表明，在分类准确度上与效率的平衡上，Darknet-53模型比ResNet-101、 ResNet-152和Darknet-19表现得更好。Yolo v3并没有那么追求速度，而是在保证实时性(fps&gt;60)的基础上追求performance。</p>
<p>一方面，Darknet-53网络采用全卷积结构，Yolo v3前向传播过程中，张量的尺寸变换是通过改变卷积核的步长来实现的。卷积的步长为2，每次经过卷积之后，图像边长缩小一半。如图2.1中所示，Darknet-53中有5次卷积的步长为2。经过5次缩小，特征图缩小为原输入尺寸的1/32。所以网络输入图片的尺寸为32的倍数，取为416×416。Yolo v2中对于前向过程中张量尺寸变换，都是通过最大池化来进行，一共有5次。而v3是通过卷积核增大步长来进行，也是5次。</p>
<p>另一方面，Darknet-53网络引入了residual结构。Yolo v2中还是类似VGG那样直筒型的网络结构，层数太多训起来会有梯度问题，所以Darknet-19也就19层。得益于ResNet的residual结构，训练深层网络的难度大大减小。因此Darknet-53网络做到53层，精度提升比较明显。</p>
<p><img src="/img/5.2/2.png" srcset="/img/loading.gif" lazyload alt="Darknet-53骨干结构"></p>
<p>Darknet-53网络只是特征提取层，源码中只使用了pooling层前面的卷积层来提取特征，因此multi-scale的特征融合和预测支路并没有在该网络结构中体现。</p>
<h1 id="边界框的预测"><a href="#边界框的预测" class="headerlink" title="边界框的预测"></a>边界框的预测</h1><p>Yolo v3关于bounding box的初始尺寸还是采用Yolo v2 中的k-means聚类的方式来做，这种先验知识对于bounding box的初始化帮助还是很大的，毕竟过多的bounding box虽然对于效果来说有保障，但是对于算法速度影响还是比较大的。</p>
<p>Yolo v2借鉴了faster R-CNN的RPN的anchor机制，不同的是，采用k-means聚类的方法来确定默认框的尺寸。Joseph Redmon修改了k-means算法中关于距离的定义，使用的是IOU距离。同样地，YOLO v3选择的默认框有9个。其尺寸可以通过k-means算法在数据集上聚类得到。在COCO数据集上，9个聚类是：（10×13）;（16×30）;（33×23）;（30×61）;（62×45）; （59×119）; （116×90）; （156×198）; （373×326）。默认框与不同尺寸特征图的对应关系是：13×13的特征图对应[（116×90），（156×198），（373×326）],26×26的特征图对应[（30×61），（62×45），（59×119）],52×52的特征图对应[（10×13），（16×30），（33×23）]。其原因是：特征图越大，感受野越小。对小目标越敏感，所以选用小的anchor box。特征图越小，感受野越大。对大目标越敏感，所以选用大的anchor box。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">YOLO_Kmeans</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cluster_number, filename</span>):</span><br>        self.cluster_number = cluster_number<br>        self.filename = <span class="hljs-string">&quot;2012_train.txt&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">iou</span>(<span class="hljs-params">self, boxes, clusters</span>):</span>  <span class="hljs-comment"># 1 box -&gt; k clusters </span><br>        n = boxes.shape[<span class="hljs-number">0</span>]<br>        k = self.cluster_number<br>        box_area = boxes[:, <span class="hljs-number">0</span>] * boxes[:, <span class="hljs-number">1</span>]<br>        box_area = box_area.repeat(k)<br>        box_area = np.reshape(box_area, (n, k))<br>        cluster_area = clusters[:, <span class="hljs-number">0</span>] * clusters[:, <span class="hljs-number">1</span>]<br>        cluster_area = np.tile(cluster_area, [<span class="hljs-number">1</span>, n])<br>        cluster_area = np.reshape(cluster_area, (n, k))<br>        box_w_matrix = np.reshape(boxes[:, <span class="hljs-number">0</span>].repeat(k), (n, k))<br>        cluster_w_matrix = np.reshape(np.tile(clusters[:, <span class="hljs-number">0</span>], (<span class="hljs-number">1</span>, n)), (n, k))<br>        min_w_matrix = np.minimum(cluster_w_matrix, box_w_matrix)<br>        box_h_matrix = np.reshape(boxes[:, <span class="hljs-number">1</span>].repeat(k), (n, k))<br>        cluster_h_matrix = np.reshape(np.tile(clusters[:, <span class="hljs-number">1</span>], (<span class="hljs-number">1</span>, n)), (n, k))<br>        min_h_matrix = np.minimum(cluster_h_matrix, box_h_matrix)<br>        inter_area = np.multiply(min_w_matrix, min_h_matrix)<br><span class="hljs-comment"># 计算IOU值</span><br>        result = inter_area / (box_area + cluster_area - inter_area)<br>        <span class="hljs-keyword">return</span> result<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">avg_iou</span>(<span class="hljs-params">self, boxes, clusters</span>):</span><br>        accuracy = np.mean([np.<span class="hljs-built_in">max</span>(self.iou(boxes, clusters), axis=<span class="hljs-number">1</span>)])<br>        <span class="hljs-keyword">return</span> accuracy<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">kmeans</span>(<span class="hljs-params">self, boxes, k, dist=np.median</span>):</span><br>	<span class="hljs-comment">#聚类问题</span><br>        box_number = boxes.shape[<span class="hljs-number">0</span>]<br>        distances = np.empty((box_number, k))<br>        last_nearest = np.zeros((box_number,))<br>        np.random.seed()<br>        clusters = boxes[np.random.choice(<br>            box_number, k, replace=<span class="hljs-literal">False</span>)]  <span class="hljs-comment"># init k clusters</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br><span class="hljs-comment">#此处没有使用欧氏距离，较大的box会比较小的box产生更多的错误。自定义的距离度量公式为：</span><br><span class="hljs-comment">#d(box,centroid)=1-IOU(box,centroid)。到聚类中心的距离越小越好，但IOU值是越大越好，所以使用 #1 - IOU，这样就保证距离越小，IOU值越大。</span><br>            distances = <span class="hljs-number">1</span> - self.iou(boxes, clusters)  <br>            current_nearest = np.argmin(distances, axis=<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> (last_nearest == current_nearest).<span class="hljs-built_in">all</span>():<br>                <span class="hljs-keyword">break</span>  <span class="hljs-comment"># clusters won&#x27;t change</span><br>            <span class="hljs-keyword">for</span> cluster <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(k):<br>                clusters[cluster] = dist(  <span class="hljs-comment"># update clusters</span><br>                    boxes[current_nearest == cluster], axis=<span class="hljs-number">0</span>)<br>            last_nearest = current_nearest<br>        <span class="hljs-keyword">return</span> clusters<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result2txt</span>(<span class="hljs-params">self, data</span>):</span><br>        f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;yolo_anchors.txt&quot;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>        row = np.shape(data)[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(row):<br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:<br>                x_y = <span class="hljs-string">&quot;%d,%d&quot;</span> % (data[i][<span class="hljs-number">0</span>], data[i][<span class="hljs-number">1</span>])<br>            <span class="hljs-keyword">else</span>:<br>                x_y = <span class="hljs-string">&quot;, %d,%d&quot;</span> % (data[i][<span class="hljs-number">0</span>], data[i][<span class="hljs-number">1</span>])<br>            f.write(x_y)<br>        f.close()<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">txt2boxes</span>(<span class="hljs-params">self</span>):</span><br>        f = <span class="hljs-built_in">open</span>(self.filename, <span class="hljs-string">&#x27;r&#x27;</span>)<br>        dataSet = []<br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:<br>            infos = line.split(<span class="hljs-string">&quot; &quot;</span>)<br>            length = <span class="hljs-built_in">len</span>(infos)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, length):<br>                width = <span class="hljs-built_in">int</span>(infos[i].split(<span class="hljs-string">&quot;,&quot;</span>)[<span class="hljs-number">2</span>]) - \<br>                    <span class="hljs-built_in">int</span>(infos[i].split(<span class="hljs-string">&quot;,&quot;</span>)[<span class="hljs-number">0</span>])<br>                height = <span class="hljs-built_in">int</span>(infos[i].split(<span class="hljs-string">&quot;,&quot;</span>)[<span class="hljs-number">3</span>]) - \<br>                    <span class="hljs-built_in">int</span>(infos[i].split(<span class="hljs-string">&quot;,&quot;</span>)[<span class="hljs-number">1</span>])<br>                dataSet.append([width, height])<br>        result = np.array(dataSet)<br>        f.close()<br>        <span class="hljs-keyword">return</span> result<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">txt2clusters</span>(<span class="hljs-params">self</span>):</span><br>        all_boxes = self.txt2boxes()<br>        result = self.kmeans(all_boxes, k=self.cluster_number)<br>        result = result[np.lexsort(result.T[<span class="hljs-number">0</span>, <span class="hljs-literal">None</span>])]<br>        self.result2txt(result)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;K anchors:\n &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(result))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Accuracy: &#123;:.2f&#125;%&quot;</span>.<span class="hljs-built_in">format</span>(<br>            self.avg_iou(all_boxes, result) * <span class="hljs-number">100</span>))<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    cluster_number = <span class="hljs-number">9</span><br>    filename = <span class="hljs-string">&quot;2012_train.txt&quot;</span><br>    kmeans = YOLO_Kmeans(cluster_number, filename)<br>    kmeans.txt2clusters()<br></code></pre></td></tr></table></figure>
<p>Yolo v3采用直接预测相对位置的方法。预测出b-box中心点相对于网格单元左上角的相对坐标。直接预测出<script type="math/tex">(t_x,t_y,t_w,t_h,t_0)</script>，然后通过以下坐标偏移公式计算得到b-box的位置大小和confidence。</p>
<script type="math/tex; mode=display">b_x=\sigma(t_x)+c_x</script><script type="math/tex; mode=display">b_y=\sigma(t_y)+c_y</script><script type="math/tex; mode=display">b_\omiga=p_\omega e^{t_w}</script><script type="math/tex; mode=display">b_h=p_he^{t_h}</script><script type="math/tex; mode=display">p_r(object)\times IOU(b,ogject)=\sigma(t_0)</script><p><script type="math/tex">t_x</script>、<script type="math/tex">t_y</script>、<script type="math/tex">t_w</script>、<script type="math/tex">t_h</script>就是模型的预测输出。<script type="math/tex">c_x</script>和<script type="math/tex">c_y</script>表示网格单元的坐标，比如某层的特征图大小是13×13，那么网格单元就有13×13个，第0行第1列的网格单元的坐标<script type="math/tex">c_x</script>就是0，<script type="math/tex">c_y</script>就是1。<script type="math/tex">p_w</script>和<script type="math/tex">p_h</script>表示预测前边界框的大小。<script type="math/tex">b_x</script>、<script type="math/tex">b_y</script>、<script type="math/tex">b_w</script>和<script type="math/tex">b_h</script>就是预测得到的边界框的中心的坐标和大小。在训练这几个坐标值的时候采用了sum of squared error loss（平方和误差损失），因为这种方式的误差可以很快的计算出来。</p>
<p>Yolo v3使用逻辑回归预测每个边界框的分数。如果边界框与真实框的重叠度比之前的任何其他边界框都要好，则该值应该为1。如果边界框不是最好的，但确实与真实对象的重叠超过某个阈值(Yolo v3中这里设定的阈值是0.5)，那么就忽略这次预测。Yolo v3只为每个真实对象分配一个边界框，如果边界框与真实对象不吻合，则不会产生坐标或类别预测损失，只会产生物体预测损失。</p>
<h1 id="类别预测"><a href="#类别预测" class="headerlink" title="类别预测"></a>类别预测</h1><p>类别预测方面主要是将原来的单标签分类改进为多标签分类，因此网络结构上就将原来用于单标签多分类的softmax层换成用于多标签多分类的Logistic分类器。Yolo v2网络中的Softmax分类器，认为一个目标只属于一个类别，通过输出Score大小，使得每个框分配到Score最大的一个类别。但在一些复杂场景下，一个目标可能属于多个类（有重叠的类别标签），因此Yolo v3用多个独立的Logistic分类器替代Softmax层解决多标签分类问题，且准确率不会下降。举例说明，原来分类网络中的softmax层都是假设一张图像或一个object只属于一个类别，但是在一些复杂场景下，一个object可能属于多个类，比如你的类别中有woman和person这两个类，那么如果一张图像中有一个woman，那么你检测的结果中类别标签就要同时有woman和person两个类，这就是 多标签分类，需要用Logistic分类器来对每个类别做二分类。 Logistic分类器主要用到sigmoid函数，该函数可以将输入约束在0到1的范围内，因此当一张图像经过特征提取后的某一类输出经过sigmoid函数约束后如果大于0.5，就表示该边界框负责的目标属于该类。</p>
<h1 id="多尺度预测"><a href="#多尺度预测" class="headerlink" title="多尺度预测"></a>多尺度预测</h1><p>Yolo v3采用多个尺度融合的方式做预测。原来的Yolo v2有一个层叫：passthrough layer，该层作用是为了加强Yolo算法对小目标检测的精确度。这个思想在Yolo v3中得到了进一步加强，在Yolo v3中采用类似FPN(feature pyramid networks)的上采样和融合做法（最后融合了3个尺度，其他两个尺度的大小分别是26×26和52×52），在多个尺度的特征图上做检测，越精细的网格就可以检测出越精细的物体。对于小目标的检测效果提升明显。</p>
<p>在结构图1中可以看出，Yolo v3设定的是每个网格单元预测3个box，所以每个box需要有<script type="math/tex">(x, y, w, h, confidence)</script>五个基本参数。Yolo v3输出了3个不同尺度的特征图，如图1所示的<script type="math/tex">y_1</script>, <script type="math/tex">y_2</script>, <script type="math/tex">y_3</script>。<script type="math/tex">y_1</script>,<script type="math/tex">y_2</script>和<script type="math/tex">y_3</script>的深度都是255，边长的规律是13:26:52。</p>
<p>每个预测任务得到的特征大小都为<script type="math/tex">N\times N\times [3\times (4+1+80)]</script> ，N为格子大小，3为每个格子得到的边界框数量， 4是边界框坐标数量，1是目标预测值，80是类别数量。对于COCO类别而言，有80个类别的概率，所以每个box应该对每个种类都输出一个概率。所以3×(5 + 80) = 255。这个255就是这么来的。</p>
<p>Yolo v3用上采样的方法来实现这种多尺度的特征图。在Darknet-53得到的特征图的基础上，经过六个DBL结构和最后一层卷积层得到第一个特征图谱，在这个特征图谱上做第一次预测。Y1支路上，从后向前的倒数第3个卷积层的输出，经过一个DBL结构和一次（2,2）上采样，将上采样特征与第2个Res8结构输出的卷积特征张量连接，经过六个DBL结构和最后一层卷积层得到第二个特征图谱，在这个特征图谱上做第二次预测。Y2支路上，从后向前倒数第3个卷积层的输出，经过一个DBL结构和一次（2,2）上采样，将上采样特征与第1个Res8结构输出的卷积特征张量连接，经过六个DBL结构和最后一层卷积层得到第三个特征图谱，在这个特征图谱上做第三次预测。</p>
<p>就整个网络而言，Yolo v3多尺度预测输出的特征图尺寸为<script type="math/tex">y_1：(13×13)，y_2：(26×26)，y_3：(52×52)</script>。网络接收一张（416×416）的图，经过5个步长为2的卷积来进行降采样（416 / 2ˆ5 = 13，<script type="math/tex">y_1</script>输出（13×13）。从<script type="math/tex">y_1</script>的倒数第二层的卷积层上采样<script type="math/tex">(x_2，up sampling)</script>再与最后一个26×26大小的特征图张量连接，<script type="math/tex">y_2</script>输出（26×26）。从<script type="math/tex">y_2</script>的倒数第二层的卷积层上采样<script type="math/tex">(x_2，up sampling)</script>再与最后一个52×52大小的特征图张量连接，<script type="math/tex">y_3</script>输出（52×52）</p>
<h1 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h1><p>在Yolo v1中使用了一种叫sum-square error的损失计算方法，只是简单的差方相加。我们知道，在目标检测任务里，有几个关键信息是需要确定的:(x,y),(w,h),class,confidence 。根据关键信息的特点可以分为上述四类，损失函数应该由各自特点确定。最后加到一起就可以组成最终的loss function了，也就是一个loss function搞定端到端的训练。</p>
<p><img src="/img/5.2/3.png" srcset="/img/loading.gif" lazyload alt="Loss Function"></p>
<p>类别预测:判断是否有对象中心落在网格中</p>
<p>下面从代码中分析v3的损失函数.keras框架描述的Yolo v3 的loss function代码，在附录yolo3.model。忽略恒定系数不看，可以从代码中看出:<br>除了w, h的损失函数依然采用总方误差之外，其他部分的损失函数用的是二值交叉熵。最后加到一起。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">xy_loss = object_mask * box_loss_scale * K.binary_crossentropy(raw_true_xy, raw_pred[...,<span class="hljs-number">0</span>:<span class="hljs-number">2</span>], from_logits=<span class="hljs-literal">True</span>)<br>wh_loss = object_mask * box_loss_scale * <span class="hljs-number">0.5</span> * K.square(raw_true_wh-raw_pred[...,<span class="hljs-number">2</span>:<span class="hljs-number">4</span>])<br><span class="hljs-comment"># 置信度</span><br>confidence_loss = object_mask * K.binary_crossentropy(object_mask, raw_pred[...,<span class="hljs-number">4</span>:<span class="hljs-number">5</span>], from_logits=<span class="hljs-literal">True</span>)+ (<span class="hljs-number">1</span>-object_mask) * K.binary_crossentropy(object_mask, raw_pred[...,<span class="hljs-number">4</span>:<span class="hljs-number">5</span>], from_logits=<span class="hljs-literal">True</span>) * ignore_mask<br><span class="hljs-comment"># 分类</span><br>class_loss = object_mask * K.binary_crossentropy(true_class_probs, raw_pred[...,<span class="hljs-number">5</span>:], from_logits=<span class="hljs-literal">True</span>)<br>xy_loss = K.<span class="hljs-built_in">sum</span>(xy_loss) / mf<br>wh_loss = K.<span class="hljs-built_in">sum</span>(wh_loss) / mf<br>confidence_loss = K.<span class="hljs-built_in">sum</span>(confidence_loss) / mf<br>class_loss = K.<span class="hljs-built_in">sum</span>(class_loss) / mf<br>loss += xy_loss + wh_loss + confidence_loss + class_loss<br></code></pre></td></tr></table></figure>
<p><img src="/img/5.2/4.png" srcset="/img/loading.gif" lazyload alt="实验目录结构"></p>
<p><img src="/img/5.2/5.png" srcset="/img/loading.gif" lazyload alt="仿真过程流程"></p>
<h1 id="使用官方模型检测"><a href="#使用官方模型检测" class="headerlink" title="使用官方模型检测"></a>使用官方模型检测</h1><p>Yolo v3的作者训练的网络基于coco数据集。下载作者的权值文件，yolov3.weights。经convert.py转换为keras的网络结构和权值文件。执行以下命令，完成模型的转换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python convert.py -w yolov3.cfg yolov3.weights model_data/yolo.h5<br></code></pre></td></tr></table></figure>
<p>需要注意的是 然后使用yolo_video.py检测图像或视频中的目标。yolov3.cfg是模型控制文件，yolov3.weights是模型权重文件，model_data/yolo.h5是输出的keras权重文件。<br>YOLO v3.cfg中的部分参数说明:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python">[net]<br><span class="hljs-comment"># Testing            ### 测试模式                                          </span><br>batch=<span class="hljs-number">1</span><br>subdivisions=<span class="hljs-number">1</span><br><span class="hljs-comment"># Training           ### 训练模式，每次前向的图片数目 = batch/subdivisions </span><br><span class="hljs-comment"># batch=64</span><br><span class="hljs-comment"># subdivisions=16</span><br>width=<span class="hljs-number">416</span>            <span class="hljs-comment">### 网络的输入宽、高、通道数                          </span><br>height=<span class="hljs-number">416</span><br>channels=<span class="hljs-number">3</span><br>momentum=<span class="hljs-number">0.9</span>         <span class="hljs-comment">### 动量                                              </span><br>decay=<span class="hljs-number">0.0005</span>         <span class="hljs-comment">### 权重衰减                                          </span><br>angle=<span class="hljs-number">0</span><br>saturation = <span class="hljs-number">1.5</span>     <span class="hljs-comment">### 饱和度                                            </span><br>exposure = <span class="hljs-number">1.5</span>       <span class="hljs-comment">### 曝光度                                            </span><br>hue=<span class="hljs-number">.1</span>               <span class="hljs-comment">### 色调                                              </span><br><br>learning_rate=<span class="hljs-number">0.001</span>  <span class="hljs-comment">### 学习率                                            </span><br>burn_in=<span class="hljs-number">1000</span>         <span class="hljs-comment">### 学习率控制的参数</span><br>max_batches = <span class="hljs-number">50200</span>  <span class="hljs-comment">### 迭代次数                                          </span><br>policy=steps         <span class="hljs-comment">### 学习率策略                                       </span><br>steps=<span class="hljs-number">40000</span>,<span class="hljs-number">45000</span>    <span class="hljs-comment">### 学习率变动步长                                   </span><br>scales=<span class="hljs-number">.1</span>,<span class="hljs-number">.1</span>         <span class="hljs-comment">### 学习率变动因子                                   </span><br><br>[convolutional]<br>batch_normalize=<span class="hljs-number">1</span>    <span class="hljs-comment">### BN</span><br>filters=<span class="hljs-number">32</span>           <span class="hljs-comment">### 卷积核数目</span><br>size=<span class="hljs-number">3</span>               <span class="hljs-comment">### 卷积核尺寸</span><br>stride=<span class="hljs-number">1</span>             <span class="hljs-comment">### 卷积核步长</span><br>pad=<span class="hljs-number">1</span>                <span class="hljs-comment">### pad</span><br>activation=leaky     <span class="hljs-comment">### 激活函数</span><br>	……<br>	[convolutional]<br>size=<span class="hljs-number">1</span><br>stride=<span class="hljs-number">1</span><br>pad=<span class="hljs-number">1</span><br>filters=<span class="hljs-number">255</span>              <span class="hljs-comment">### 3x(classes + 4coor + 1prob) = 3x(20+4+1) = 75              </span><br>activation=linear<br><br>[yolo]<br>mask = <span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>            <span class="hljs-comment">### mask序号                        </span><br>anchors = <span class="hljs-number">10</span>,<span class="hljs-number">13</span>,  <span class="hljs-number">16</span>,<span class="hljs-number">30</span>,  <span class="hljs-number">33</span>,<span class="hljs-number">23</span>,  <span class="hljs-number">30</span>,<span class="hljs-number">61</span>,  <span class="hljs-number">62</span>,<span class="hljs-number">45</span>,  <span class="hljs-number">59</span>,<span class="hljs-number">119</span>,  <span class="hljs-number">116</span>,<span class="hljs-number">90</span>,  <span class="hljs-number">156</span>,<span class="hljs-number">198</span>,  <span class="hljs-number">373</span>,<span class="hljs-number">326</span>  <br>classes=<span class="hljs-number">80</span>              <span class="hljs-comment">### 类比数目                        </span><br>num=<span class="hljs-number">9</span><br>jitter=<span class="hljs-number">.3</span>               <span class="hljs-comment">### 数据扩充的抖动操作              </span><br>ignore_thresh = <span class="hljs-number">.5</span>      <span class="hljs-comment">### 文章中的阈值1                   </span><br>truth_thresh = <span class="hljs-number">1</span>        <span class="hljs-comment">### 文章中的阈值2                   </span><br>random=<span class="hljs-number">1</span>                <span class="hljs-comment">### 多尺度训练开关   </span><br></code></pre></td></tr></table></figure>
<p>检测使用的脚本分析放在使用自己的数据集训练并检测的部分。这里先给出使用官方权重文件的检测结果。使用python yolo_video.py –image命令，输入类别为狗，鸟，人的图片各一张，得到图片的检测结果。</p>
<p><img src="/img/5.2/6.png" srcset="/img/loading.gif" lazyload alt="检测结果"></p>
<p>使用以下命令得到视频的检测结果:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python yolo_video.py [video_path] [output_path (optional)]<br></code></pre></td></tr></table></figure>
<p><img src="/img/5.2/7.png" srcset="/img/loading.gif" lazyload alt="检测结果"></p>
<p>自己训练数据集并检测 用于Keras-yolo训练的数据集格式为VOC格式。本文使用的数据集是由监控摄像头拍摄得到的视频随机截取得到的帧图像。训练集包含 people（人），front（车前），side（车侧身）和back（车尾）四个类别。 首先，构建图7.6所示的数据集目录结构。将数据集图片都复制到JPEGImages目录下。使用Labelimg工具，人工标注训练集，把标注工具输出的文件复制到Annotations目录下。</p>
<p><img src="/img/5.2/8.png" srcset="/img/loading.gif" lazyload alt="VOC 数据集目录结构"></p>
<p>在VOC下新建名为test.py的python文件。该python文件，读入’Annotations’目录下的xml文件，将90%的图片划分为训练集，10%的图片用作训练-验证集。训练-验证集的10%用作验证集。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> random<br>trainval_percent = <span class="hljs-number">0.1</span> <span class="hljs-comment">#验证集比例</span><br>train_percent = <span class="hljs-number">0.9</span> <span class="hljs-comment">#训练集比例</span><br>xmlfilepath = <span class="hljs-string">&#x27;Annotations&#x27;</span><br>txtsavepath = <span class="hljs-string">&#x27;ImageSets\Main&#x27;</span><br>total_xml = os.listdir(xmlfilepath)<br>num = <span class="hljs-built_in">len</span>(total_xml)<br><span class="hljs-built_in">list</span> = <span class="hljs-built_in">range</span>(num)<br>tv = <span class="hljs-built_in">int</span>(num * trainval_percent)<br>tr = <span class="hljs-built_in">int</span>(tv * train_percent)<br>trainval = random.sample(<span class="hljs-built_in">list</span>, tv)<br>train = random.sample(trainval, tr)<br>ftrainval = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ImageSets/Main/trainval.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>ftest = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ImageSets/Main/test.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>ftrain = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ImageSets/Main/train.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br>fval = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;ImageSets/Main/val.txt&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">list</span>:<br>    name = total_xml[i][:-<span class="hljs-number">4</span>] + <span class="hljs-string">&#x27;\n&#x27;</span><br>    <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> trainval:<br>        ftrainval.write(name)  <span class="hljs-comment">#10%的图片用作训练-验证集</span><br>        <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> train:<br>            ftest.write(name)  <span class="hljs-comment">#训练-验证集的90%用作测试集</span><br>        <span class="hljs-keyword">else</span>:<br>            fval.write(name)  <span class="hljs-comment">#训练-验证集的10%用作验证集</span><br>    <span class="hljs-keyword">else</span>:<br>        ftrain.write(name)   <span class="hljs-comment">#90%的图片作为训练集</span><br>ftrainval.close()<br>ftrain.close()<br>fval.close()<br>ftest.close()<br></code></pre></td></tr></table></figure>
<p>最后将划分好的图片名称分别保存到’ImageSets\Main’目录下，trainval.txt，test.txt,train.txt和val.txt四个文件中。<br>该工程中使用的数据格式是: image_file_path box1 box2 … boxN; 边界框格式是: x_min,y_min,x_max,y_max,class_id (no space)。对于VOC数据集，需要使用voc_annotation.py脚本进行转换。在主目录下生成test.txt,train.txt和val.txt，包含上一步生成的训练集、验证集和测试集的图片的路径和（x，y，w，h，class）真实值信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> getcwd<br>sets=[(<span class="hljs-string">&#x27;2007&#x27;</span>, <span class="hljs-string">&#x27;train&#x27;</span>), (<span class="hljs-string">&#x27;2007&#x27;</span>, <span class="hljs-string">&#x27;val&#x27;</span>), (<span class="hljs-string">&#x27;2007&#x27;</span>, <span class="hljs-string">&#x27;test&#x27;</span>)]<br>classes = [<span class="hljs-string">&quot;people&quot;</span>,<span class="hljs-string">&quot;front&quot;</span>,<span class="hljs-string">&quot;side&quot;</span>,<span class="hljs-string">&quot;back&quot;</span>] <span class="hljs-comment">#数据集中所标记的四个类别</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_annotation</span>(<span class="hljs-params">year, image_id, list_file</span>):</span><br>    in_file =<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/home/fengzicai/Documents/keras-yolo3/VOC%s/Annotations/%s.xml&#x27;</span>%(year, image_id))<br>    tree=ET.parse(in_file)<br>    root = tree.getroot()<br>    <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> root.<span class="hljs-built_in">iter</span>(<span class="hljs-string">&#x27;object&#x27;</span>):<br>        difficult = obj.find(<span class="hljs-string">&#x27;difficult&#x27;</span>).text<br>        cls = obj.find(<span class="hljs-string">&#x27;name&#x27;</span>).text<br>        <span class="hljs-keyword">if</span> cls <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> classes <span class="hljs-keyword">or</span> <span class="hljs-built_in">int</span>(difficult)==<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">continue</span><br>        cls_id = classes.index(cls)<br>        xmlbox = obj.find(<span class="hljs-string">&#x27;bndbox&#x27;</span>)<br>        b = (<span class="hljs-built_in">int</span>(xmlbox.find(<span class="hljs-string">&#x27;xmin&#x27;</span>).text), <span class="hljs-built_in">int</span>(xmlbox.find(<span class="hljs-string">&#x27;ymin&#x27;</span>).text), <span class="hljs-built_in">int</span>(xmlbox.find(<span class="hljs-string">&#x27;xmax&#x27;</span>).text), <span class="hljs-built_in">int</span>(xmlbox.find(<span class="hljs-string">&#x27;ymax&#x27;</span>).text))<br>        list_file.write(<span class="hljs-string">&quot; &quot;</span> + <span class="hljs-string">&quot;,&quot;</span>.join([<span class="hljs-built_in">str</span>(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> b]) + <span class="hljs-string">&#x27;,&#x27;</span> + <span class="hljs-built_in">str</span>(cls_id))<br>wd = getcwd()<br><span class="hljs-keyword">for</span> year, image_set <span class="hljs-keyword">in</span> sets:<br>    image_ids = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/home/fengzicai/Documents/keras-yolo3/VOC%s/ImageSets/Main/%s.txt&#x27;</span>%(year, image_set)).read().strip().split()<br>    list_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;%s_%s.txt&#x27;</span>%(year, image_set), <span class="hljs-string">&#x27;w&#x27;</span>)<br>    <span class="hljs-keyword">for</span> image_id <span class="hljs-keyword">in</span> image_ids:<br>        list_file.write(<span class="hljs-string">&#x27;%s/VOC%s/JPEGImages/%s.jpg&#x27;</span>%(wd, year, image_id))<br>        convert_annotation(year, image_id, list_file)<br>        list_file.write(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    list_file.close()<br><span class="hljs-comment">#至此，VOC格式的数据集就准备好了。然后将四类标签名写入model_data/coco_classes.txt和model/voc_classes.txt中。model_data/ yolo_anchors.txt填写通过K聚类得到的9个anchor。</span><br></code></pre></td></tr></table></figure>
<p>下一步开始准备训练。训练过程函数调用关系如图:</p>
<p><img src="/img/5.2/9.png" srcset="/img/loading.gif" lazyload alt="训练过程函数调用关系"></p>
<p>训练脚本train.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Retrain the YOLO model for your own dataset.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> keras.backend <span class="hljs-keyword">as</span> K<br><span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Input, Lambda<br><span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Model<br><span class="hljs-keyword">from</span> keras.callbacks <span class="hljs-keyword">import</span> TensorBoard, ModelCheckpoint, EarlyStopping<br><br><span class="hljs-keyword">from</span> yolo3.model <span class="hljs-keyword">import</span> preprocess_true_boxes, yolo_body, tiny_yolo_body, yolo_loss<br><span class="hljs-keyword">from</span> yolo3.utils <span class="hljs-keyword">import</span> get_random_data<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_main</span>():</span><br>    annotation_path = <span class="hljs-string">&#x27;train.txt&#x27;</span><br>    log_dir = <span class="hljs-string">&#x27;logs/000/&#x27;</span>  <span class="hljs-comment">#保存权重文件的路径</span><br>    classes_path = <span class="hljs-string">&#x27;model_data/voc_classes.txt&#x27;</span>  <span class="hljs-comment">#保存分类信息文件的路径</span><br>    anchors_path = <span class="hljs-string">&#x27;model_data/yolo_anchors.txt&#x27;</span>  <span class="hljs-comment">#保存默认框信息的路径</span><br>    class_names = get_classes(classes_path)<br>    anchors = get_anchors(anchors_path)<br>    input_shape = (<span class="hljs-number">416</span>,<span class="hljs-number">416</span>) <span class="hljs-comment"># multiple of 32, hw</span><br>    model = create_model(input_shape, anchors, <span class="hljs-built_in">len</span>(class_names) )<br>    train(model, annotation_path, input_shape, anchors, <span class="hljs-built_in">len</span>(class_names), log_dir=log_dir)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span>(<span class="hljs-params">model, annotation_path, input_shape, anchors, num_classes, log_dir=<span class="hljs-string">&#x27;logs/&#x27;</span></span>):</span><br>    model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">&#x27;adam&#x27;</span>, loss=&#123;<br>        <span class="hljs-string">&#x27;yolo_loss&#x27;</span>: <span class="hljs-keyword">lambda</span> y_true, y_pred: y_pred&#125;)<br>    logging = TensorBoard(log_dir=log_dir)<br>    checkpoint = ModelCheckpoint(log_dir + <span class="hljs-string">&quot;ep&#123;epoch:03d&#125;-loss&#123;loss:.3f&#125;-val_loss&#123;val_loss:.3f&#125;.h5&quot;</span>,<br>        monitor=<span class="hljs-string">&#x27;val_loss&#x27;</span>, save_weights_only=<span class="hljs-literal">True</span>, save_best_only=<span class="hljs-literal">True</span>, period=<span class="hljs-number">1</span>)<br>    batch_size = <span class="hljs-number">10</span><br>    val_split = <span class="hljs-number">0.1</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(annotation_path) <span class="hljs-keyword">as</span> f:<br>        lines = f.readlines()<br>    np.random.shuffle(lines)<br>    num_val = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">len</span>(lines)*val_split)<br>    num_train = <span class="hljs-built_in">len</span>(lines) - num_val<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Train on &#123;&#125; samples, val on &#123;&#125; samples, with batch size &#123;&#125;.&#x27;</span>.<span class="hljs-built_in">format</span>(num_train, num_val, batch_size))<br><br>    model.fit_generator(data_generator_wrap(lines[:num_train], batch_size, input_shape, anchors, num_classes),<br>            steps_per_epoch=<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, num_train//batch_size),<br>            validation_data=data_generator_wrap(lines[num_train:], batch_size, input_shape, anchors, num_classes),<br>            validation_steps=<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, num_val//batch_size),<br>            epochs=<span class="hljs-number">500</span>,<br>            initial_epoch=<span class="hljs-number">0</span>)<br>    model.save_weights(log_dir + <span class="hljs-string">&#x27;trained_weights.h5&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_classes</span>(<span class="hljs-params">classes_path</span>):</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(classes_path) <span class="hljs-keyword">as</span> f:<br>        class_names = f.readlines()<br>    class_names = [c.strip() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> class_names]<br>    <span class="hljs-keyword">return</span> class_names<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_anchors</span>(<span class="hljs-params">anchors_path</span>):</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(anchors_path) <span class="hljs-keyword">as</span> f:<br>        anchors = f.readline()<br>    anchors = [<span class="hljs-built_in">float</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> anchors.split(<span class="hljs-string">&#x27;,&#x27;</span>)]<br><span class="hljs-keyword">return</span> np.array(anchors).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>	<span class="hljs-comment">#该函数用于创建模型</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_model</span>(<span class="hljs-params">input_shape, anchors, num_classes, load_pretrained=<span class="hljs-literal">False</span>, freeze_body=<span class="hljs-literal">False</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">            weights_path=<span class="hljs-string">&#x27;model_data/yolo_weights.h5&#x27;</span></span>):</span><br>    K.clear_session() <span class="hljs-comment"># get a new session</span><br>    image_input = Input(shape=(<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-number">3</span>))<br>    h, w = input_shape<br>    num_anchors = <span class="hljs-built_in">len</span>(anchors)<br>    y_true = [Input(shape=(h//&#123;<span class="hljs-number">0</span>:<span class="hljs-number">32</span>, <span class="hljs-number">1</span>:<span class="hljs-number">16</span>, <span class="hljs-number">2</span>:<span class="hljs-number">8</span>&#125;[l], w//&#123;<span class="hljs-number">0</span>:<span class="hljs-number">32</span>, <span class="hljs-number">1</span>:<span class="hljs-number">16</span>, <span class="hljs-number">2</span>:<span class="hljs-number">8</span>&#125;[l], \<br>        num_anchors//<span class="hljs-number">3</span>, num_classes+<span class="hljs-number">5</span>)) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br><span class="hljs-comment">#预测每个尺度的3个框，所以对于4个边界框偏移量，1个目标性预测和4个类别预测，张量为#N×N×[3 *（4 + 1 + 4）]，默认参数下：y_true[l]的shape为（batch,H,W,3,num_classes+5)</span><br>model_body = yolo_body(image_input, num_anchors//<span class="hljs-number">3</span>, num_classes)<br>	<span class="hljs-comment"># yolo_body()函数从yolo3.model中引入</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Create YOLOv3 model with &#123;&#125; anchors and &#123;&#125; classes.&#x27;</span>.<span class="hljs-built_in">format</span>(num_anchors, num_classes))<br><br>    <span class="hljs-keyword">if</span> load_pretrained:<br>        model_body.load_weights(weights_path, by_name=<span class="hljs-literal">True</span>, skip_mismatch=<span class="hljs-literal">True</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Load weights &#123;&#125;.&#x27;</span>.<span class="hljs-built_in">format</span>(weights_path))<br>        <span class="hljs-keyword">if</span> freeze_body:<br>            <span class="hljs-comment"># Do not freeze 3 output layers.</span><br>            num = <span class="hljs-built_in">len</span>(model_body.layers)-<span class="hljs-number">7</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num): model_body.layers[i].trainable = <span class="hljs-literal">False</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Freeze the first &#123;&#125; layers of total &#123;&#125; layers.&#x27;</span>.<span class="hljs-built_in">format</span>(num, <span class="hljs-built_in">len</span>(model_body.layers)))<br><span class="hljs-comment">#生成模型损失</span><br>    model_loss = Lambda(yolo_loss, output_shape=(<span class="hljs-number">1</span>,), name=<span class="hljs-string">&#x27;yolo_loss&#x27;</span>,<br>        arguments=&#123;<span class="hljs-string">&#x27;anchors&#x27;</span>: anchors, <span class="hljs-string">&#x27;num_classes&#x27;</span>: num_classes, <span class="hljs-string">&#x27;ignore_thresh&#x27;</span>: <span class="hljs-number">0.5</span>&#125;)(<br>        [*model_body.output, *y_true])<br>    model = Model([model_body.<span class="hljs-built_in">input</span>, *y_true], model_loss)<br><span class="hljs-keyword">return</span> model<br>	<span class="hljs-comment">#通过train.py(data_generator)生成数据</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">data_generator</span>(<span class="hljs-params">annotation_lines, batch_size, input_shape, anchors, num_classes</span>):</span><br>    n = <span class="hljs-built_in">len</span>(annotation_lines)<br>    np.random.shuffle(annotation_lines)<br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        image_data = []<br>        box_data = []<br>        <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):<br>            i %= n<br>            image, box = get_random_data(annotation_lines[i], input_shape, random=<span class="hljs-literal">True</span>)<br>            image_data.append(image)<br>            box_data.append(box)<br>            i += <span class="hljs-number">1</span><br>        image_data = np.array(image_data)<br>        box_data = np.array(box_data)<br>        y_true = preprocess_true_boxes(box_data, input_shape, anchors, num_classes)<br>        <span class="hljs-keyword">yield</span> [image_data, *y_true], np.zeros(batch_size)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">data_generator_wrap</span>(<span class="hljs-params">annotation_lines, batch_size, input_shape, anchors, num_classes</span>):</span><br>    n = <span class="hljs-built_in">len</span>(annotation_lines)<br>    <span class="hljs-keyword">if</span> n==<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> batch_size&lt;=<span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> data_generator(annotation_lines, batch_size, input_shape, anchors, num_classes)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>_main()<br></code></pre></td></tr></table></figure>
<p>使用自己的数据集进行检测过程与使用官方权重文件进行检测过程相同。使用python yolo_img.py –image执行检测脚本。检测脚本yolo_img.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">from</span> yolo <span class="hljs-keyword">import</span> YOLO, detect_video<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> glob<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">detect_img</span>(<span class="hljs-params">yolo</span>):</span><br>    path = <span class="hljs-string">&quot;/home/fengzicai/Documents/keras-yolo3/VOC2007/JPEGImages/*.jpg&quot;</span> <span class="hljs-comment">#要读入的图片路径</span><br>    outdir = <span class="hljs-string">&quot;/home/fengzicai/Documents/keras-yolo3/VOC2007/SegmentationClass&quot;</span> <span class="hljs-comment">#将检测的结果全保#存到outdir路径</span><br>    <span class="hljs-keyword">for</span> jpgfile <span class="hljs-keyword">in</span> glob.glob(path):<br>        img = Image.<span class="hljs-built_in">open</span>(jpgfile)<br>        img = yolo.detect_image(img)  <span class="hljs-comment">#调用yolo类中的detect_image函数，对图片进行检测，见#yolo脚本</span><br>        img.save(os.path.join(outdir, os.path.basename(jpgfile)))<br>    yolo.close_session()<br>FLAGS = <span class="hljs-literal">None</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># class YOLO defines the default value, so suppress any default here</span><br>    parser = argparse.ArgumentParser(argument_default=argparse.SUPPRESS)<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    Command line options</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;--model&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;path to model weight file, default &#x27;</span> + YOLO.get_defaults(<span class="hljs-string">&quot;model_path&quot;</span>)<br>    )<br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;--anchors&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;path to anchor definitions, default &#x27;</span> + YOLO.get_defaults(<span class="hljs-string">&quot;anchors_path&quot;</span>)<br>    )<br><br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;--classes&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;path to class definitions, default &#x27;</span> + YOLO.get_defaults(<span class="hljs-string">&quot;classes_path&quot;</span>)<br>    )<br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;--gpu_num&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>,<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Number of GPU to use, default &#x27;</span> + <span class="hljs-built_in">str</span>(YOLO.get_defaults(<span class="hljs-string">&quot;gpu_num&quot;</span>))<br>    )<br>    parser.add_argument(<br>        <span class="hljs-string">&#x27;--image&#x27;</span>, default=<span class="hljs-literal">False</span>, action=<span class="hljs-string">&quot;store_true&quot;</span>,<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Image detection mode, will ignore all positional arguments&#x27;</span><br>    )<br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    Command line positional arguments -- for video detection mode</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    parser.add_argument(<br>        <span class="hljs-string">&quot;--input&quot;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>,required=<span class="hljs-literal">False</span>,default=<span class="hljs-string">&#x27;./path2your_video&#x27;</span>,<br>        <span class="hljs-built_in">help</span> = <span class="hljs-string">&quot;Video input path&quot;</span><br>    )<br>    parser.add_argument(<br>        <span class="hljs-string">&quot;--output&quot;</span>, nargs=<span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">str</span>, default=<span class="hljs-string">&quot;&quot;</span>,<br>        <span class="hljs-built_in">help</span> = <span class="hljs-string">&quot;[Optional] Video output path&quot;</span><br>    )<br>    FLAGS = parser.parse_args()<br>    <span class="hljs-keyword">if</span> FLAGS.image:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Image detection mode, disregard any remaining command line arguments</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Image detection mode&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;input&quot;</span> <span class="hljs-keyword">in</span> FLAGS:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot; Ignoring remaining command line arguments: &quot;</span> + FLAGS.<span class="hljs-built_in">input</span> + <span class="hljs-string">&quot;,&quot;</span> + FLAGS.output)<br>        detect_img(YOLO(**<span class="hljs-built_in">vars</span>(FLAGS)))<br>    <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;input&quot;</span> <span class="hljs-keyword">in</span> FLAGS:<br>        detect_video(YOLO(**<span class="hljs-built_in">vars</span>(FLAGS)), FLAGS.<span class="hljs-built_in">input</span>, FLAGS.output)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Must specify at least video_input_path.  See usage with --help.&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>Yolo_img.py在执行时，导入了yolo.py脚本，包含图像和视频中YOLO v3模型检测的类定义。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Class definition of YOLO_v3 style detection model on image and video</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> colorsys<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> timeit <span class="hljs-keyword">import</span> default_timer <span class="hljs-keyword">as</span> timer<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> backend <span class="hljs-keyword">as</span> K<br><span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> load_model<br><span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Input<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageFont, ImageDraw<br><br><span class="hljs-keyword">from</span> yolo3.model <span class="hljs-keyword">import</span> yolo_eval, yolo_body, tiny_yolo_body<br><span class="hljs-keyword">from</span> yolo3.utils <span class="hljs-keyword">import</span> letterbox_image<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> keras.utils <span class="hljs-keyword">import</span> multi_gpu_model<br><span class="hljs-comment">#YOLO类的初始化参数</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">YOLO</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    _defaults = &#123;<br>        <span class="hljs-comment">#&quot;model_path&quot;: &#x27;model_data/yolo.h5&#x27;,</span><br>        <span class="hljs-string">&quot;model_path&quot;</span>: <span class="hljs-string">&#x27;logs/001/trained_weights.h5&#x27;</span>, <span class="hljs-comment">#训练好的模型</span><br>        <span class="hljs-string">&quot;anchors_path&quot;</span>: <span class="hljs-string">&#x27;model_data/yolo_anchors.txt&#x27;</span>, <span class="hljs-comment">#有9个anchor box，从小到大排列</span><br>        <span class="hljs-string">&quot;classes_path&quot;</span>: <span class="hljs-string">&#x27;model_data/coco_classes.txt&#x27;</span>, <span class="hljs-comment">#类别数目</span><br>        <span class="hljs-string">&quot;score&quot;</span> : <span class="hljs-number">0.3</span>, <span class="hljs-comment">#score阈值</span><br>        <span class="hljs-string">&quot;iou&quot;</span> : <span class="hljs-number">0.45</span>, <span class="hljs-comment">#iou 阈值</span><br>        <span class="hljs-string">&quot;model_image_size&quot;</span> : (<span class="hljs-number">416</span>, <span class="hljs-number">416</span>), <span class="hljs-comment">#输入图像尺寸</span><br>        <span class="hljs-string">&quot;gpu_num&quot;</span> : <span class="hljs-number">1</span>, <span class="hljs-comment">#gpu数量</span><br>    &#125;<br><br><span class="hljs-meta">    @classmethod</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_defaults</span>(<span class="hljs-params">cls, n</span>):</span><br>        <span class="hljs-keyword">if</span> n <span class="hljs-keyword">in</span> cls._defaults:<br>            <span class="hljs-keyword">return</span> cls._defaults[n]<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unrecognized attribute name &#x27;&quot;</span> + n + <span class="hljs-string">&quot;&#x27;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, **kwargs</span>):</span><br>        self.__dict__.update(self._defaults) <span class="hljs-comment"># set up default values</span><br>        self.__dict__.update(kwargs) <span class="hljs-comment"># and update with user overrides</span><br>        self.class_names = self._get_class()<br>        self.anchors = self._get_anchors()<br>        self.sess = K.get_session()<br>        self.boxes, self.scores, self.classes = self.generate()<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_class</span>(<span class="hljs-params">self</span>):</span><br>        classes_path = os.path.expanduser(self.classes_path)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(classes_path) <span class="hljs-keyword">as</span> f:<br>            class_names = f.readlines()<br>        class_names = [c.strip() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> class_names]<br>        <span class="hljs-keyword">return</span> class_names<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_anchors</span>(<span class="hljs-params">self</span>):</span><br>        anchors_path = os.path.expanduser(self.anchors_path)<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(anchors_path) <span class="hljs-keyword">as</span> f:<br>            anchors = f.readline()<br>        anchors = [<span class="hljs-built_in">float</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> anchors.split(<span class="hljs-string">&#x27;,&#x27;</span>)]<br>        <span class="hljs-keyword">return</span> np.array(anchors).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate</span>(<span class="hljs-params">self</span>):</span> <span class="hljs-comment">#yolo_img.py中调用了该函数</span><br>        model_path = os.path.expanduser(self.model_path)  <span class="hljs-comment">#获取model路径</span><br>        <span class="hljs-keyword">assert</span> model_path.endswith(<span class="hljs-string">&#x27;.h5&#x27;</span>), <span class="hljs-string">&#x27;Keras model or weights must be a .h5 file.&#x27;</span> <br>		<span class="hljs-comment">#判断model是否以h5结尾</span><br>        <span class="hljs-comment"># Load model, or construct model and load weights.</span><br>        num_anchors = <span class="hljs-built_in">len</span>(self.anchors) <span class="hljs-comment">#num_anchors = 9。yolov3有9个先验框</span><br>        num_classes = <span class="hljs-built_in">len</span>(self.class_names) <span class="hljs-comment">#num_cliasses = 4。一共有四个类别</span><br>        is_tiny_version = num_anchors==<span class="hljs-number">6</span> <span class="hljs-comment"># default setting</span><br>        <span class="hljs-keyword">try</span>:<br>            self.yolo_model = load_model(model_path, <span class="hljs-built_in">compile</span>=<span class="hljs-literal">False</span>) <span class="hljs-comment">#下载model</span><br>        <span class="hljs-keyword">except</span>:<br>            self.yolo_model=tiny_yolo_body(Input(shape=(<span class="hljs-literal">None</span>,<span class="hljs-literal">None</span>,<span class="hljs-number">3</span>)), num_anchors//<span class="hljs-number">2</span>, <br>num_classes) \<br>            <span class="hljs-keyword">if</span> is_tiny_version <span class="hljs-keyword">else</span> yolo_body(Input(shape=(<span class="hljs-literal">None</span>,<span class="hljs-literal">None</span>,<span class="hljs-number">3</span>)), num_anchors//<span class="hljs-number">3</span>, num_classes)<br>            self.yolo_model.load_weights(self.model_path) <span class="hljs-comment"># 确保model和anchor classes 对应</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">assert</span> self.yolo_model.layers[-<span class="hljs-number">1</span>].output_shape[-<span class="hljs-number">1</span>] == \<br>	<span class="hljs-comment"># model.layer[-1]:网络最后一层输出。 output_shape[-1]:输出维度的最后一维。 -&gt; (?,13,13,27)</span><br>                num_anchors/<span class="hljs-built_in">len</span>(self.yolo_model.output) * (num_classes + <span class="hljs-number">5</span>), \<br><span class="hljs-comment">#27 = 9/3*(4+5). 9/3:每层网格对应3个anchor box 4：4个类别 5:4+1,框的4个值+1个置信度</span><br>                <span class="hljs-string">&#x27;Mismatch between model and given anchor and class sizes&#x27;</span><br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#123;&#125; model, anchors, and classes loaded.&#x27;</span>.<span class="hljs-built_in">format</span>(model_path))<br><br>        <span class="hljs-comment"># 生成绘制边框的颜色</span><br>        hsv_tuples = [(x / <span class="hljs-built_in">len</span>(self.class_names), <span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>)<br>	<span class="hljs-comment">#h(色调）：x/len(self.class_names)  s(饱和度）：1.0  v(明亮）：1.0</span><br>                      <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(self.class_names))]<br>        self.colors = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: colorsys.hsv_to_rgb(*x), hsv_tuples))  <span class="hljs-comment">#hsv转换为rgb</span><br>        self.colors = <span class="hljs-built_in">list</span>(<br>            <span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: (<span class="hljs-built_in">int</span>(x[<span class="hljs-number">0</span>] * <span class="hljs-number">255</span>), <span class="hljs-built_in">int</span>(x[<span class="hljs-number">1</span>] * <span class="hljs-number">255</span>), <span class="hljs-built_in">int</span>(x[<span class="hljs-number">2</span>] * <span class="hljs-number">255</span>)),<br>                self.colors))<br>	<span class="hljs-comment">#hsv取值范围在[0,1]，而RBG取值范围在[0,255]，所以乘上255</span><br>        np.random.seed(<span class="hljs-number">10101</span>)  <span class="hljs-comment"># np.random.seed():产生随机种子。固定种子为一致的颜色</span><br>        np.random.shuffle(self.colors)  <span class="hljs-comment"># 调整颜色来装饰相邻的类。</span><br>        np.random.seed(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 重置种子为默认</span><br><br>        <span class="hljs-comment">#为过滤的边界框生成输出张量目标。</span><br>        self.input_image_shape = K.placeholder(shape=(<span class="hljs-number">2</span>, )) <span class="hljs-comment">#K.placeholder:keras中的占位符</span><br>        <span class="hljs-keyword">if</span> self.gpu_num&gt;=<span class="hljs-number">2</span>:<br>            self.yolo_model = multi_gpu_model(self.yolo_model, gpus=self.gpu_num)<br>        boxes, scores, classes = yolo_eval(self.yolo_model.output, self.anchors,<br>                <span class="hljs-built_in">len</span>(self.class_names), self.input_image_shape,<br>                score_threshold=self.score, iou_threshold=self.iou) <span class="hljs-comment">#yolo_eval():yolo评估函数</span><br>        <span class="hljs-keyword">return</span> boxes, scores, classes<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">detect_image</span>(<span class="hljs-params">self, image</span>):</span> <span class="hljs-comment"># yolo_img.py中调用了该函数</span><br>        start = timer()<br>        <span class="hljs-keyword">if</span> self.model_image_size != (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>): <span class="hljs-comment">#判断图片是否存在</span><br>            <span class="hljs-keyword">assert</span> self.model_image_size[<span class="hljs-number">0</span>]%<span class="hljs-number">32</span> == <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;Multiples of 32 required&#x27;</span><br>            <span class="hljs-keyword">assert</span> self.model_image_size[<span class="hljs-number">1</span>]%<span class="hljs-number">32</span> == <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;Multiples of 32 required&#x27;</span><br>	<span class="hljs-comment">#assert断言语句的语法格式 model_image_size[0][1]指图像的w和h，且必须是32的整数倍</span><br>            boxed_image = letterbox_image(image, <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">reversed</span>(self.model_image_size)))<br>	<span class="hljs-comment"># letterbox_image()定义见附录中的yolo3.utils。输入参数（图像 ,(w=416,h=416)),</span><br><span class="hljs-comment">#输出一张使用填充来调整图像的纵横比不变的新图。</span><br>        <span class="hljs-keyword">else</span>:<br>            new_image_size = (image.width - (image.width % <span class="hljs-number">32</span>),<br>                              image.height - (image.height % <span class="hljs-number">32</span>))<br>            boxed_image = letterbox_image(image, new_image_size)<br>        image_data = np.array(boxed_image, dtype=<span class="hljs-string">&#x27;float32&#x27;</span>)<br><br>        <span class="hljs-built_in">print</span>(image_data.shape) <span class="hljs-comment">#(416,416,3)</span><br>        image_data /= <span class="hljs-number">255.</span> <span class="hljs-comment">#归一化</span><br>        image_data = np.expand_dims(image_data, <span class="hljs-number">0</span>)  <span class="hljs-comment"># Add batch dimension.</span><br>	<span class="hljs-comment">#添加批量维度为 (1,416,416,3)，使输入网络的张量满足(bitch, w, h, c)的格式</span><br>        out_boxes, out_scores, out_classes = self.sess.run(<br>            [self.boxes, self.scores, self.classes],<br>	<span class="hljs-comment">#目的为了求boxes,scores,classes，具体计算方式定义在generate（）函数内。在yolo.py中</span><br>            feed_dict=&#123; <br>                self.yolo_model.<span class="hljs-built_in">input</span>: image_data,  <span class="hljs-comment">#图像数据</span><br>                self.input_image_shape: [image.size[<span class="hljs-number">1</span>], image.size[<span class="hljs-number">0</span>]], <span class="hljs-comment">#图像尺寸</span><br>                K.learning_phase(): <span class="hljs-number">0</span> <span class="hljs-comment">#学习模式 0：测试模型。1：训练模式</span><br>            &#125;)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Found &#123;&#125; boxes for &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">len</span>(out_boxes), <span class="hljs-string">&#x27;img&#x27;</span>))<br>	<span class="hljs-comment">#绘制边框，自动设置边框宽度，绘制边框和类别文字，使用pillow绘图库。</span><br>        font = ImageFont.truetype(font=<span class="hljs-string">&#x27;font/FiraMono-Medium.otf&#x27;</span>,<br>                    size=np.floor(<span class="hljs-number">3e-2</span> * image.size[<span class="hljs-number">1</span>] + <span class="hljs-number">0.5</span>).astype(<span class="hljs-string">&#x27;int32&#x27;</span>)) <span class="hljs-comment">#设置字体</span><br>        thickness = (image.size[<span class="hljs-number">0</span>] + image.size[<span class="hljs-number">1</span>]) // <span class="hljs-number">300</span> <span class="hljs-comment">#设置厚度</span><br><br>        <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">enumerate</span>(out_classes))):<br>            predicted_class = self.class_names[c] <span class="hljs-comment">#类别</span><br>            box = out_boxes[i] <span class="hljs-comment">#框</span><br>            score = out_scores[i] <span class="hljs-comment">#置信度</span><br><br>            label = <span class="hljs-string">&#x27;&#123;&#125; &#123;:.2f&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(predicted_class, score) <span class="hljs-comment">#标签</span><br>            draw = ImageDraw.Draw(image) <span class="hljs-comment">#画图</span><br>            label_size = draw.textsize(label, font) <span class="hljs-comment">#标签文字</span><br><br>            top, left, bottom, right = box<br>            top = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, np.floor(top + <span class="hljs-number">0.5</span>).astype(<span class="hljs-string">&#x27;int32&#x27;</span>))<br>            left = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, np.floor(left + <span class="hljs-number">0.5</span>).astype(<span class="hljs-string">&#x27;int32&#x27;</span>))<br>            bottom = <span class="hljs-built_in">min</span>(image.size[<span class="hljs-number">1</span>], np.floor(bottom + <span class="hljs-number">0.5</span>).astype(<span class="hljs-string">&#x27;int32&#x27;</span>))<br>            right = <span class="hljs-built_in">min</span>(image.size[<span class="hljs-number">0</span>], np.floor(right + <span class="hljs-number">0.5</span>).astype(<span class="hljs-string">&#x27;int32&#x27;</span>))<br>            <span class="hljs-built_in">print</span>(label, (left, top), (right, bottom)) <span class="hljs-comment">#边框</span><br><br>            <span class="hljs-keyword">if</span> top - label_size[<span class="hljs-number">1</span>] &gt;= <span class="hljs-number">0</span>: <span class="hljs-comment">#标签文字</span><br>                text_origin = np.array([left, top - label_size[<span class="hljs-number">1</span>]])<br>            <span class="hljs-keyword">else</span>:<br>                text_origin = np.array([left, top + <span class="hljs-number">1</span>])<br><br>            <span class="hljs-comment"># My kingdom for a good redistributable image drawing library.</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(thickness): <span class="hljs-comment">#画边框</span><br>                draw.rectangle(<br>                    [left + i, top + i, right - i, bottom - i],<br>                    outline=self.colors[c])<br>            draw.rectangle( <span class="hljs-comment">#文字背景</span><br>                [<span class="hljs-built_in">tuple</span>(text_origin), <span class="hljs-built_in">tuple</span>(text_origin + label_size)],<br>                fill=self.colors[c])<br>            draw.text(text_origin, label, fill=(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), font=font)<br>            <span class="hljs-keyword">del</span> draw<br><br>        end = timer()<br>        <span class="hljs-built_in">print</span>(end - start)<br>        <span class="hljs-keyword">return</span> image<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close_session</span>(<span class="hljs-params">self</span>):</span><br>        self.sess.close()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">detect_video</span>(<span class="hljs-params">yolo, video_path, output_path=<span class="hljs-string">&quot;&quot;</span></span>):</span><br>    <span class="hljs-keyword">import</span> cv2<br>    vid = cv2.VideoCapture(video_path)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> vid.isOpened():<br>        <span class="hljs-keyword">raise</span> IOError(<span class="hljs-string">&quot;Couldn&#x27;t open webcam or video&quot;</span>)<br>    video_FourCC    = <span class="hljs-built_in">int</span>(vid.get(cv2.CAP_PROP_FOURCC))<br>    video_fps       = vid.get(cv2.CAP_PROP_FPS)<br>    video_size      = (<span class="hljs-built_in">int</span>(vid.get(cv2.CAP_PROP_FRAME_WIDTH)),<br>                        <span class="hljs-built_in">int</span>(vid.get(cv2.CAP_PROP_FRAME_HEIGHT)))<br>    isOutput = <span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> output_path != <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> isOutput:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;!!! TYPE:&quot;</span>, <span class="hljs-built_in">type</span>(output_path), <span class="hljs-built_in">type</span>(video_FourCC), <span class="hljs-built_in">type</span>(video_fps), <span class="hljs-built_in">type</span>(video_size))<br>        out = cv2.VideoWriter(output_path, video_FourCC, video_fps, video_size)<br>    accum_time = <span class="hljs-number">0</span><br>    curr_fps = <span class="hljs-number">0</span><br>    fps = <span class="hljs-string">&quot;FPS: ??&quot;</span><br>    prev_time = timer()<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        return_value, frame = vid.read()<br>        <span class="hljs-comment">#frame_array = np.asarray(frame)</span><br>        image = Image.fromarray(frame)<br>        image = yolo.detect_image(image)<br>        result = np.asarray(image)<br>        curr_time = timer()<br>        exec_time = curr_time - prev_time<br>        prev_time = curr_time<br>        accum_time = accum_time + exec_time<br>        curr_fps = curr_fps + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">if</span> accum_time &gt; <span class="hljs-number">1</span>:<br>            accum_time = accum_time - <span class="hljs-number">1</span><br>            fps = <span class="hljs-string">&quot;FPS: &quot;</span> + <span class="hljs-built_in">str</span>(curr_fps)<br>            curr_fps = <span class="hljs-number">0</span><br>        cv2.putText(result, text=fps, org=(<span class="hljs-number">3</span>, <span class="hljs-number">15</span>), fontFace=cv2.FONT_HERSHEY_SIMPLEX,<br>                    fontScale=<span class="hljs-number">0.50</span>, color=(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), thickness=<span class="hljs-number">2</span>)<br>        cv2.namedWindow(<span class="hljs-string">&quot;result&quot;</span>, cv2.WINDOW_NORMAL)<br>        cv2.imshow(<span class="hljs-string">&quot;result&quot;</span>, result)<br>        <span class="hljs-keyword">if</span> isOutput:<br>            out.write(result)<br>        <span class="hljs-keyword">if</span> cv2.waitKey(<span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFF</span> == <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;q&#x27;</span>):<br>            <span class="hljs-keyword">break</span><br>yolo.close_session()<br></code></pre></td></tr></table></figure>
<p><img src="/img/5.2/10.png" srcset="/img/loading.gif" lazyload alt="检测结果"></p>
<p><img src="/img/5.2/11.png" srcset="/img/loading.gif" lazyload alt="检测结果"></p>
<p>附录A</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br></pre></td><td class="code"><pre><code class="hljs python">训练和检测都导入了yolo3.model：<br><span class="hljs-string">&quot;&quot;&quot;YOLO_v3 Model Defined in Keras.&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps<br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<br><span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> backend <span class="hljs-keyword">as</span> K<br><span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Conv2D, Add, ZeroPadding2D, UpSampling2D, Concatenate, MaxPooling2D<br><span class="hljs-keyword">from</span> keras.layers.advanced_activations <span class="hljs-keyword">import</span> LeakyReLU<br><span class="hljs-keyword">from</span> keras.layers.normalization <span class="hljs-keyword">import</span> BatchNormalization<br><span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Model<br><span class="hljs-keyword">from</span> keras.regularizers <span class="hljs-keyword">import</span> l2<br><br><span class="hljs-keyword">from</span> yolo3.utils <span class="hljs-keyword">import</span> compose<br><br><span class="hljs-comment"># DarknetConv2D()，DarknetConv2D_BN_Leaky()，resblock_body()三个函数构成了darknet_body()卷积层框#架</span><br><span class="hljs-meta">@wraps(<span class="hljs-params">Conv2D</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">DarknetConv2D</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Wrapper to set Darknet parameters for Convolution2D.&quot;&quot;&quot;</span><br>    darknet_conv_kwargs = &#123;<span class="hljs-string">&#x27;kernel_regularizer&#x27;</span>: l2(<span class="hljs-number">5e-4</span>)&#125;<br>    darknet_conv_kwargs[<span class="hljs-string">&#x27;padding&#x27;</span>] = <span class="hljs-string">&#x27;valid&#x27;</span> <span class="hljs-keyword">if</span> kwargs.get(<span class="hljs-string">&#x27;strides&#x27;</span>)==(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;same&#x27;</span><br>    darknet_conv_kwargs.update(kwargs)<br>    <span class="hljs-keyword">return</span> Conv2D(*args, **darknet_conv_kwargs)<br><span class="hljs-comment">#注意 DARKNET卷积这里激活函数是LEAKYRELU</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">DarknetConv2D_BN_Leaky</span>(<span class="hljs-params">*args, **kwargs</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Darknet Convolution2D followed by BatchNormalization and LeakyReLU.&quot;&quot;&quot;</span><br>    no_bias_kwargs = &#123;<span class="hljs-string">&#x27;use_bias&#x27;</span>: <span class="hljs-literal">False</span>&#125;<br>    no_bias_kwargs.update(kwargs)<br>    <span class="hljs-keyword">return</span> compose(<br>        DarknetConv2D(*args, **no_bias_kwargs),<br>        BatchNormalization(),<br>        LeakyReLU(alpha=<span class="hljs-number">0.1</span>))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resblock_body</span>(<span class="hljs-params">x, num_filters, num_blocks</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;A series of resblocks starting with a downsampling Convolution2D&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># Darknet uses left and top padding instead of &#x27;same&#x27; mode</span><br>	<span class="hljs-comment"># Darknet使用向左和向上填充代替same模式。</span><br>	<span class="hljs-comment">#DARKNET每块之间，使用了，（1，0，1，0）的PADDING层。</span><br>    x = ZeroPadding2D(((<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)))(x)<br>    x = DarknetConv2D_BN_Leaky(num_filters, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>))(x)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks):<br>        y = compose(<br>                DarknetConv2D_BN_Leaky(num_filters//<span class="hljs-number">2</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>                DarknetConv2D_BN_Leaky(num_filters, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)))(x)<br>        x = Add()([x,y])<br><span class="hljs-keyword">return</span> x<br>	<span class="hljs-comment">#创建darknet网络结构，有52层卷积层。包含五个resblock</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">darknet_body</span>(<span class="hljs-params">x</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Darknent body having 52 Convolution2D layers&#x27;&#x27;&#x27;</span><br>    x = DarknetConv2D_BN_Leaky(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>))(x)<br>    x = resblock_body(x, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>)<br>    x = resblock_body(x, <span class="hljs-number">128</span>, <span class="hljs-number">2</span>)<br>    x = resblock_body(x, <span class="hljs-number">256</span>, <span class="hljs-number">8</span>)<br>    x = resblock_body(x, <span class="hljs-number">512</span>, <span class="hljs-number">8</span>)<br>    x = resblock_body(x, <span class="hljs-number">1024</span>, <span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">return</span> x<br><span class="hljs-comment">#Convs由make_last_layers函数来实现。</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_last_layers</span>(<span class="hljs-params">x, num_filters, out_filters</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;6 Conv2D_BN_Leaky layers followed by a Conv2D_linear layer&#x27;&#x27;&#x27;</span><br>    x = compose(<br>            DarknetConv2D_BN_Leaky(num_filters, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>            DarknetConv2D_BN_Leaky(num_filters*<span class="hljs-number">2</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D_BN_Leaky(num_filters, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>            DarknetConv2D_BN_Leaky(num_filters*<span class="hljs-number">2</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D_BN_Leaky(num_filters, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))(x)<br>    y = compose(<br>            DarknetConv2D_BN_Leaky(num_filters*<span class="hljs-number">2</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D(out_filters, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))(x)<br>    <span class="hljs-keyword">return</span> x, y<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_body</span>(<span class="hljs-params">inputs, num_anchors, num_classes</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Create YOLO_V3 model CNN body in Keras.&quot;&quot;&quot;</span><br>darknet = Model(inputs, darknet_body(inputs)) <span class="hljs-comment"># darknet_body(inputs)创建一个darknet网络</span><br>	<span class="hljs-comment">#以下语句是特征金字塔（FPN）的具体实现。 </span><br>    x, y1 = make_last_layers(darknet.output, <span class="hljs-number">512</span>, num_anchors*(num_classes+<span class="hljs-number">5</span>))<br>	<span class="hljs-comment">#compose函数，从左向右评估函数</span><br>    x = compose(<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">256</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>            UpSampling2D(<span class="hljs-number">2</span>))(x)<br>    x = Concatenate()([x,darknet.layers[<span class="hljs-number">152</span>].output])<br>    x, y2 = make_last_layers(x, <span class="hljs-number">256</span>, num_anchors*(num_classes+<span class="hljs-number">5</span>))<br><br>    x = compose(<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">128</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>            UpSampling2D(<span class="hljs-number">2</span>))(x)<br>    x = Concatenate()([x,darknet.layers[<span class="hljs-number">92</span>].output])<br>    x, y3 = make_last_layers(x, <span class="hljs-number">128</span>, num_anchors*(num_classes+<span class="hljs-number">5</span>))<br><br>    <span class="hljs-keyword">return</span> Model(inputs, [y1,y2,y3])<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tiny_yolo_body</span>(<span class="hljs-params">inputs, num_anchors, num_classes</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Create Tiny YOLO_v3 model CNN body in keras.&#x27;&#x27;&#x27;</span><br>    x1 = compose(<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">16</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">128</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">256</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)))(inputs)<br>    x2 = compose(<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">512</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            MaxPooling2D(pool_size=(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), strides=(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>), padding=<span class="hljs-string">&#x27;same&#x27;</span>),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">1024</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">256</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))(x1)<br>    y1 = compose(<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">512</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D(num_anchors*(num_classes+<span class="hljs-number">5</span>), (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))(x2)<br><br>    x2 = compose(<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">128</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>            UpSampling2D(<span class="hljs-number">2</span>))(x2)<br>    y2 = compose(<br>            Concatenate(),<br>            DarknetConv2D_BN_Leaky(<span class="hljs-number">256</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)),<br>            DarknetConv2D(num_anchors*(num_classes+<span class="hljs-number">5</span>), (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))([x2,x1])<br><br>    <span class="hljs-keyword">return</span> Model(inputs, [y1,y2])<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_head</span>(<span class="hljs-params">feats, anchors, num_classes, input_shape, calc_loss=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Convert final layer features to bounding box parameters.&quot;&quot;&quot;</span><br>    num_anchors = <span class="hljs-built_in">len</span>(anchors)  <span class="hljs-comment">#num_anchors = 3</span><br>    <span class="hljs-comment"># Reshape to batch, height, width, num_anchors, box_params.</span><br>    anchors_tensor = K.reshape(K.constant(anchors), [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, num_anchors, <span class="hljs-number">2</span>])  <span class="hljs-comment">#reshape -&gt;(1,1,1,3,2)</span><br>grid_shape = K.shape(feats)[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]   <span class="hljs-comment"># height, width   (?,13,13,27) -&gt; (13,13)</span><br><span class="hljs-comment">#grid_y和grid_x用于生成网格grid，通过arange、reshape、tile的组合， 创建y轴的0~12的组合#grid_y，再创建x轴的0~12的组合grid_x，将两者拼接concatenate，就是grid；</span><br>    grid_y = K.tile(K.reshape(K.arange(<span class="hljs-number">0</span>, stop=grid_shape[<span class="hljs-number">0</span>]), [-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]),<br>        [<span class="hljs-number">1</span>, grid_shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br>    grid_x = K.tile(K.reshape(K.arange(<span class="hljs-number">0</span>, stop=grid_shape[<span class="hljs-number">1</span>]), [<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]),<br>        [grid_shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br>    grid = K.concatenate([grid_x, grid_y])<br>    grid = K.cast(grid, K.dtype(feats))  <span class="hljs-comment">#K.cast():把grid中值的类型变为和feats中值的类型一样</span><br><br>    feats = K.reshape(<br>        feats, [-<span class="hljs-number">1</span>, grid_shape[<span class="hljs-number">0</span>], grid_shape[<span class="hljs-number">1</span>], num_anchors, num_classes + <span class="hljs-number">5</span>])<br><span class="hljs-comment">#将feats的最后一维展开，将anchors与其他数据（类别数+4个框值+框置信度）分离</span><br><br><span class="hljs-comment"># Adjust preditions to each spatial grid point and anchor size.</span><br>	<span class="hljs-comment">#xywh的计算公式，见边界框回归公式。</span><br><span class="hljs-comment">#tx、ty、tw和th是feats值，而bx、by、bw和bh是输出值</span><br>    box_xy = (K.sigmoid(feats[..., :<span class="hljs-number">2</span>]) + grid) / K.cast(grid_shape[::-<span class="hljs-number">1</span>], K.dtype(feats))  <span class="hljs-comment">#sigmoid:σ</span><br>    box_wh = K.exp(feats[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>]) * anchors_tensor / K.cast(input_shape[::-<span class="hljs-number">1</span>], K.dtype(feats))<br>    box_confidence = K.sigmoid(feats[..., <span class="hljs-number">4</span>:<span class="hljs-number">5</span>])<br>box_class_probs = K.sigmoid(feats[..., <span class="hljs-number">5</span>:])<br>	<span class="hljs-comment"># ...操作符，在Python中，“...”(ellipsis)操作符，表示其他维度不变，只操作最前或最后1维；</span><br>    <span class="hljs-keyword">if</span> calc_loss == <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">return</span> grid, feats, box_xy, box_wh<br><span class="hljs-comment"># 将box_xy，box_xy 从OUTPUT的预测数据转为真实坐标。</span><br>    <span class="hljs-keyword">return</span> box_xy, box_wh, box_confidence, box_class_probs<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_correct_boxes</span>(<span class="hljs-params">box_xy, box_wh, input_shape, image_shape</span>):</span>  <span class="hljs-comment">#得到正确的x,y,w,h</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Get corrected boxes&#x27;&#x27;&#x27;</span><br>    box_yx = box_xy[..., ::-<span class="hljs-number">1</span>]  <span class="hljs-comment">#“::-1”是颠倒数组的值</span><br>    box_hw = box_wh[..., ::-<span class="hljs-number">1</span>]   <br>    input_shape = K.cast(input_shape, K.dtype(box_yx))<br>    image_shape = K.cast(image_shape, K.dtype(box_yx))<br>    new_shape = K.<span class="hljs-built_in">round</span>(image_shape * K.<span class="hljs-built_in">min</span>(input_shape/image_shape))<br>    offset = (input_shape-new_shape)/<span class="hljs-number">2.</span>/input_shape<br>    scale = input_shape/new_shape<br>    box_yx = (box_yx - offset) * scale<br>    box_hw *= scale<br><br>    box_mins = box_yx - (box_hw / <span class="hljs-number">2.</span>)<br>    box_maxes = box_yx + (box_hw / <span class="hljs-number">2.</span>)<br>    boxes =  K.concatenate([<br>        box_mins[..., <span class="hljs-number">0</span>:<span class="hljs-number">1</span>],  <span class="hljs-comment"># y_min</span><br>        box_mins[..., <span class="hljs-number">1</span>:<span class="hljs-number">2</span>],  <span class="hljs-comment"># x_min</span><br>        box_maxes[..., <span class="hljs-number">0</span>:<span class="hljs-number">1</span>],  <span class="hljs-comment"># y_max</span><br>        box_maxes[..., <span class="hljs-number">1</span>:<span class="hljs-number">2</span>]  <span class="hljs-comment"># x_max</span><br>    ])<br><br>    <span class="hljs-comment"># Scale boxes back to original image shape.</span><br>    boxes *= K.concatenate([image_shape, image_shape])<br>    <span class="hljs-keyword">return</span> boxes<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_boxes_and_scores</span>(<span class="hljs-params">feats, anchors, num_classes, input_shape, image_shape</span>):</span><br><span class="hljs-comment"># feats:输出的shape，-&gt;(?,13,13,27); anchors:每层对应的3个anchor box</span><br><span class="hljs-comment"># num_classes: 类别数（4）; input_shape:（416,416）; image_shape:图像尺寸</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Process Conv layer output&#x27;&#x27;&#x27;</span><br>    box_xy, box_wh, box_confidence, box_class_probs = yolo_head(feats,<br>        anchors, num_classes, input_shape)<br><span class="hljs-comment">#yolo_head():box_xy是box的中心坐标，(0~1)相对位置；box_wh是box的宽高，(0~1)相对值；</span><br><span class="hljs-comment">#box_confidence是框中物体置信度；box_class_probs是类别置信度；</span><br>boxes = yolo_correct_boxes(box_xy, box_wh, input_shape, image_shape)<br><span class="hljs-comment">#将box_xy和box_wh的(0~1)相对值，转换为真实坐标，输出boxes是(y_min,x_min,y_max,x_max)的#值</span><br>boxes = K.reshape(boxes, [-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>])<br>	<span class="hljs-comment">#reshape,将不同网格的值转换为框的列表。即（?,13,13,3,4）-&gt;(?,4)  ？：框的数目</span><br>box_scores = box_confidence * box_class_probs<br>	<span class="hljs-comment">#框的得分=框的置信度*类别置信度</span><br>    box_scores = K.reshape(box_scores, [-<span class="hljs-number">1</span>, num_classes])<br><span class="hljs-comment">#reshape,将框的得分展平，变为(?,4); ?:框的数目</span><br>    <span class="hljs-keyword">return</span> boxes, box_scores<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_eval</span>(<span class="hljs-params">yolo_outputs, </span></span><br><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">#模型输出，格式如下[（?，13,13,27）（?，26,26,27）（?,52,52,27）] ?:bitch size; 13-26-52:多尺度预测； 27：预测值（3*（4+5））</span></span></span><br><span class="hljs-function"><span class="hljs-params">              anchors,</span></span><br><span class="hljs-function"><span class="hljs-params">	<span class="hljs-comment">#[(10,13), (16,30), (33,23), (30,61), (62,45), (59,119), (116,90), (156,198),(373,326)]</span></span></span><br><span class="hljs-function"><span class="hljs-params">              num_classes, <span class="hljs-comment"># 类别个数，此数据集有4类 </span></span></span><br><span class="hljs-function"><span class="hljs-params">              image_shape, <span class="hljs-comment">#placeholder类型的TF参数，默认(416, 416)；</span></span></span><br><span class="hljs-function"><span class="hljs-params">              max_boxes=<span class="hljs-number">20</span>,</span></span><br><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">#每张图每类最多检测到20个框同类别框的IoU阈值，大于阈值的重叠框被删除，重叠物体较多，则调高阈值，重叠物体较少，则调低阈值</span></span></span><br><span class="hljs-function"><span class="hljs-params">              score_threshold=<span class="hljs-number">.6</span>,</span></span><br><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">#框置信度阈值，小于阈值的框被删除，需要的框较多，则调低阈值，需要的框较少，则调高阈值；</span></span></span><br><span class="hljs-function"><span class="hljs-params">              iou_threshold=<span class="hljs-number">.5</span></span>):</span><br><span class="hljs-comment">#同类别框的IoU阈值，大于阈值的重叠框被删除，重叠物体较多，则调高阈值，重叠物体较少，则调低阈值</span><br>    <span class="hljs-string">&quot;&quot;&quot;Evaluate YOLO model on given input and return filtered boxes.&quot;&quot;&quot;</span><br>num_layers = <span class="hljs-built_in">len</span>(yolo_outputs) <span class="hljs-comment">#yolo的输出层数；num_layers = 3  -&gt; 13-26-52</span><br>	<span class="hljs-comment"># 不同的欺骗对应不同的ANCHOR大小。</span><br>    anchor_mask = [[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]] <span class="hljs-keyword">if</span> num_layers==<span class="hljs-number">3</span> <span class="hljs-keyword">else</span> [[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]] <span class="hljs-comment"># default setting</span><br><span class="hljs-comment">#每层分配3个anchor box.如13*13分配到[6,7,8]即[（116,90）（156,198）（373,326）]</span><br>input_shape = K.shape(yolo_outputs[<span class="hljs-number">0</span>])[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>] * <span class="hljs-number">32</span><br>	<span class="hljs-comment">#输入shape(?,13,13,255);即第一维和第二维分别乘32，输出的图片尺寸为（416,416）</span><br>    boxes = []<br>    box_scores = []<br>    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers):<br>        _boxes, _box_scores = yolo_boxes_and_scores(yolo_outputs[l], <br>	<span class="hljs-comment"># yolo_boxes_and_scores()函数见附录yolo3.model</span><br>            anchors[anchor_mask[l]], num_classes, input_shape, image_shape)<br>        boxes.append(_boxes)<br>        box_scores.append(_box_scores)<br>    boxes = K.concatenate(boxes, axis=<span class="hljs-number">0</span>) <span class="hljs-comment">#K.concatenate:将数据展平 -&gt;(?,4)</span><br>    box_scores = K.concatenate(box_scores, axis=<span class="hljs-number">0</span>) <span class="hljs-comment"># -&gt;(?,)</span><br><br>    mask = box_scores &gt;= score_threshold <br><span class="hljs-comment">#MASK掩码，过滤小于score阈值的值，只保留大于阈值的值</span><br>    max_boxes_tensor = K.constant(max_boxes, dtype=<span class="hljs-string">&#x27;int32&#x27;</span>) <span class="hljs-comment">#最大检测框数20</span><br>    boxes_ = []<br>    scores_ = []<br>    classes_ = []<br>    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_classes):<br>        <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> use keras backend instead of tf.</span><br>        class_boxes = tf.boolean_mask(boxes, mask[:, c]) <span class="hljs-comment">#通过掩码MASK和类别C筛选框boxes</span><br>        class_box_scores = tf.boolean_mask(box_scores[:, c], mask[:, c]) <br><span class="hljs-comment">#通过掩码MASK和类别C筛选scores</span><br>        nms_index = tf.image.non_max_suppression(  <span class="hljs-comment">#运行非极大抑制</span><br>            class_boxes, class_box_scores, max_boxes_tensor, iou_threshold=iou_threshold)<br>        class_boxes = K.gather(class_boxes, nms_index)<br>	<span class="hljs-comment">#K.gather:根据索引nms_index选择class_boxes</span><br>        class_box_scores = K.gather(class_box_scores, nms_index)<br>	<span class="hljs-comment">#根据索引nms_index选择class_box_score)</span><br>        classes = K.ones_like(class_box_scores, <span class="hljs-string">&#x27;int32&#x27;</span>) * c <span class="hljs-comment">#计算类的框得分</span><br>        boxes_.append(class_boxes)<br>        scores_.append(class_box_scores)<br>        classes_.append(classes)<br>boxes_ = K.concatenate(boxes_, axis=<span class="hljs-number">0</span>)<br><span class="hljs-comment">#K.concatenate().将相同维度的数据连接在一起；把boxes_展平。  -&gt; 变成格式:(?,4);  ?:框的个#数；4：（x,y,w,h）</span><br>    scores_ = K.concatenate(scores_, axis=<span class="hljs-number">0</span>)<br>    classes_ = K.concatenate(classes_, axis=<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> boxes_, scores_, classes_<br>	<span class="hljs-comment">#图片缩放到固定大小之后就是生成对应的数据</span><br>	<span class="hljs-comment">#通过model.py(preprocess_true_boxes实现box框的框定</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">preprocess_true_boxes</span>(<span class="hljs-params">true_boxes, input_shape, anchors, num_classes</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Preprocess true boxes to training input format</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Parameters</span><br><span class="hljs-string">    ----------</span><br><span class="hljs-string">    true_boxes: array, shape=(m, T, 5)</span><br><span class="hljs-string">        Absolute x_min, y_min, x_max, y_max, class_id relative to input_shape.</span><br><span class="hljs-string">    input_shape: array-like, hw, multiples of 32</span><br><span class="hljs-string">    anchors: array, shape=(N, 2), wh</span><br><span class="hljs-string">    num_classes: integer</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns</span><br><span class="hljs-string">    -------</span><br><span class="hljs-string">    y_true: list of array, shape like yolo_outputs, xywh are reletive value</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">assert</span> (true_boxes[..., <span class="hljs-number">4</span>]&lt;num_classes).<span class="hljs-built_in">all</span>(), <span class="hljs-string">&#x27;class id must be less than num_classes&#x27;</span><br>num_layers = <span class="hljs-built_in">len</span>(anchors)//<span class="hljs-number">3</span> <span class="hljs-comment"># default setting</span><br>	<span class="hljs-comment"># 不同的欺骗对应不同的ANCHOR大小。</span><br>    anchor_mask = [[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]] <span class="hljs-keyword">if</span> num_layers==<span class="hljs-number">3</span> <span class="hljs-keyword">else</span> [[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]]<br><br>    true_boxes = np.array(true_boxes, dtype=<span class="hljs-string">&#x27;float32&#x27;</span>)<br>    input_shape = np.array(input_shape, dtype=<span class="hljs-string">&#x27;int32&#x27;</span>)<br>    boxes_xy = (true_boxes[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] + true_boxes[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>]) // <span class="hljs-number">2</span><br>    boxes_wh = true_boxes[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] - true_boxes[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br><span class="hljs-comment"># 生成true_box做了类似归一化的处理，因此，true_box小于1，box_loss_scale一定大于0.</span><br>    true_boxes[..., <span class="hljs-number">0</span>:<span class="hljs-number">2</span>] = boxes_xy/input_shape[::-<span class="hljs-number">1</span>]<br>    true_boxes[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] = boxes_wh/input_shape[::-<span class="hljs-number">1</span>]<br><br>    m = true_boxes.shape[<span class="hljs-number">0</span>]<br>    grid_shapes = [input_shape//&#123;<span class="hljs-number">0</span>:<span class="hljs-number">32</span>, <span class="hljs-number">1</span>:<span class="hljs-number">16</span>, <span class="hljs-number">2</span>:<span class="hljs-number">8</span>&#125;[l] <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)]<br>    y_true = [np.zeros((m,grid_shapes[l][<span class="hljs-number">0</span>],grid_shapes[l][<span class="hljs-number">1</span>],<span class="hljs-built_in">len</span>(anchor_mask[l]),<span class="hljs-number">5</span>+num_classes),<br>        dtype=<span class="hljs-string">&#x27;float32&#x27;</span>) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)]<br><br>    <span class="hljs-comment"># Expand dim to apply broadcasting.</span><br>    anchors = np.expand_dims(anchors, <span class="hljs-number">0</span>)<br>    anchor_maxes = anchors / <span class="hljs-number">2.</span><br>    anchor_mins = -anchor_maxes<br>    valid_mask = boxes_wh[..., <span class="hljs-number">0</span>]&gt;<span class="hljs-number">0</span><br>	<span class="hljs-comment">#每个图片都需要单独处理。</span><br>    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m):<br>        <span class="hljs-comment"># Discard zero rows.</span><br>        wh = boxes_wh[b, valid_mask[b]]<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(wh)==<span class="hljs-number">0</span>: <span class="hljs-keyword">continue</span><br>        <span class="hljs-comment"># Expand dim to apply broadcasting.</span><br>        wh = np.expand_dims(wh, -<span class="hljs-number">2</span>)<br>        box_maxes = wh / <span class="hljs-number">2.</span><br>        box_mins = -box_maxes<br><br>        intersect_mins = np.maximum(box_mins, anchor_mins)<br>        intersect_maxes = np.minimum(box_maxes, anchor_maxes)<br>        intersect_wh = np.maximum(intersect_maxes - intersect_mins, <span class="hljs-number">0.</span>)<br>        intersect_area = intersect_wh[..., <span class="hljs-number">0</span>] * intersect_wh[..., <span class="hljs-number">1</span>]<br>        box_area = wh[..., <span class="hljs-number">0</span>] * wh[..., <span class="hljs-number">1</span>]<br>        anchor_area = anchors[..., <span class="hljs-number">0</span>] * anchors[..., <span class="hljs-number">1</span>]<br>        iou = intersect_area / (box_area + anchor_area - intersect_area)<br><br>        <span class="hljs-comment"># Find best anchor for each true box</span><br><span class="hljs-comment"># 9个设定的ANCHOR去框定每个输入的BOX。</span><br>        best_anchor = np.argmax(iou, axis=-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">for</span> t, n <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(best_anchor):<br>            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers):<br>                <span class="hljs-keyword">if</span> n <span class="hljs-keyword">in</span> anchor_mask[l]:<br>                    i = np.floor(true_boxes[b,t,<span class="hljs-number">0</span>]*grid_shapes[l][<span class="hljs-number">1</span>]).astype(<span class="hljs-string">&#x27;int32&#x27;</span>)<br>                    j = np.floor(true_boxes[b,t,<span class="hljs-number">1</span>]*grid_shapes[l][<span class="hljs-number">0</span>]).astype(<span class="hljs-string">&#x27;int32&#x27;</span>)<br>                    k = anchor_mask[l].index(n)<br>                    c = true_boxes[b,t, <span class="hljs-number">4</span>].astype(<span class="hljs-string">&#x27;int32&#x27;</span>)<br>				 <span class="hljs-comment"># 设定数据</span><br>				 <span class="hljs-comment"># 将T个box的标的数据统一放置到3*B*W*H*3的维度上。</span><br>                    y_true[l][b, j, i, k, <span class="hljs-number">0</span>:<span class="hljs-number">4</span>] = true_boxes[b,t, <span class="hljs-number">0</span>:<span class="hljs-number">4</span>]<br>                    y_true[l][b, j, i, k, <span class="hljs-number">4</span>] = <span class="hljs-number">1</span><br>                    y_true[l][b, j, i, k, <span class="hljs-number">5</span>+c] = <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">return</span> y_true<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">box_iou</span>(<span class="hljs-params">b1, b2</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Return iou tensor</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Parameters</span><br><span class="hljs-string">    ----------</span><br><span class="hljs-string">    b1: tensor, shape=(i1,...,iN, 4), xywh</span><br><span class="hljs-string">    b2: tensor, shape=(j, 4), xywh</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns</span><br><span class="hljs-string">    -------</span><br><span class="hljs-string">    iou: tensor, shape=(i1,...,iN, j)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br><br>    <span class="hljs-comment"># Expand dim to apply broadcasting.</span><br>    b1 = K.expand_dims(b1, -<span class="hljs-number">2</span>)<br>    b1_xy = b1[..., :<span class="hljs-number">2</span>]<br>    b1_wh = b1[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>]<br>    b1_wh_half = b1_wh/<span class="hljs-number">2.</span><br>    b1_mins = b1_xy - b1_wh_half<br>    b1_maxes = b1_xy + b1_wh_half<br><br>    <span class="hljs-comment"># Expand dim to apply broadcasting.</span><br>    b2 = K.expand_dims(b2, <span class="hljs-number">0</span>)<br>    b2_xy = b2[..., :<span class="hljs-number">2</span>]<br>    b2_wh = b2[..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>]<br>    b2_wh_half = b2_wh/<span class="hljs-number">2.</span><br>    b2_mins = b2_xy - b2_wh_half<br>    b2_maxes = b2_xy + b2_wh_half<br><br>    intersect_mins = K.maximum(b1_mins, b2_mins)<br>    intersect_maxes = K.minimum(b1_maxes, b2_maxes)<br>    intersect_wh = K.maximum(intersect_maxes - intersect_mins, <span class="hljs-number">0.</span>)<br>    intersect_area = intersect_wh[..., <span class="hljs-number">0</span>] * intersect_wh[..., <span class="hljs-number">1</span>]<br>    b1_area = b1_wh[..., <span class="hljs-number">0</span>] * b1_wh[..., <span class="hljs-number">1</span>]<br>    b2_area = b2_wh[..., <span class="hljs-number">0</span>] * b2_wh[..., <span class="hljs-number">1</span>]<br>    iou = intersect_area / (b1_area + b2_area - intersect_area)<br><br>    <span class="hljs-keyword">return</span> iou<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">yolo_loss</span>(<span class="hljs-params">args, anchors, num_classes, ignore_thresh=<span class="hljs-number">.5</span>, print_loss=<span class="hljs-literal">False</span></span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;Return yolo_loss tensor </span><br><span class="hljs-string"></span><br><span class="hljs-string">    Parameters</span><br><span class="hljs-string">    ----------</span><br><span class="hljs-string">    yolo_outputs: list of tensor, the output of yolo_body or tiny_yolo_body</span><br><span class="hljs-string">    y_true: list of array, the output of preprocess_true_boxes</span><br><span class="hljs-string">    anchors: array, shape=(N, 2), wh</span><br><span class="hljs-string">    num_classes: integer</span><br><span class="hljs-string">    ignore_thresh: float, the iou threshold whether to ignore object confidence loss</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns</span><br><span class="hljs-string">    -------</span><br><span class="hljs-string">    loss: tensor, shape=(1,)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    num_layers = <span class="hljs-built_in">len</span>(anchors)//<span class="hljs-number">3</span> <span class="hljs-comment"># default setting</span><br>    yolo_outputs = args[:num_layers]<br>y_true = args[num_layers:]<br>	<span class="hljs-comment"># 不同的欺骗对应不同的ANCHOR大小。</span><br>anchor_mask = [[<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>], [<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]] <span class="hljs-keyword">if</span> num_layers==<span class="hljs-number">3</span> <span class="hljs-keyword">else</span> [[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]]<br>	<span class="hljs-comment"># 根据模型返回的OUTPUT计算输入图片SHAPE以及3个LAYER下，3个切片的大小。</span><br>    input_shape = K.cast(K.shape(yolo_outputs[<span class="hljs-number">0</span>])[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>] * <span class="hljs-number">32</span>, K.dtype(y_true[<span class="hljs-number">0</span>]))<br>    grid_shapes = [K.cast(K.shape(yolo_outputs[l])[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>], K.dtype(y_true[<span class="hljs-number">0</span>])) <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers)]<br>    loss = <span class="hljs-number">0</span><br>m = K.shape(yolo_outputs[<span class="hljs-number">0</span>])[<span class="hljs-number">0</span>] <span class="hljs-comment"># batch size, tensor #m表示采样batch_size</span><br>    mf = K.cast(m, K.dtype(yolo_outputs[<span class="hljs-number">0</span>]))<br><span class="hljs-comment"># loss是需要三层分别计算的</span><br><span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers):<br>	   <span class="hljs-comment"># 置信率</span><br>        object_mask = y_true[l][..., <span class="hljs-number">4</span>:<span class="hljs-number">5</span>]<br>        <span class="hljs-comment"># 分类</span><br>        true_class_probs = y_true[l][..., <span class="hljs-number">5</span>:]<br>	<span class="hljs-comment"># raw_pred是yolo_outputs[l]，经过yolo_head函数后，raw_pred数据并没有改变。</span><br>        grid, raw_pred, pred_xy, pred_wh = yolo_head(yolo_outputs[l],<br>             anchors[anchor_mask[l]], num_classes, input_shape, calc_loss=<span class="hljs-literal">True</span>)<br>        pred_box = K.concatenate([pred_xy, pred_wh])<br><br>        <span class="hljs-comment"># Darknet raw box to calculate loss.</span><br>	<span class="hljs-comment"># Darknet原始盒子来计算损失。</span><br>        raw_true_xy = y_true[l][..., :<span class="hljs-number">2</span>]*grid_shapes[l][::-<span class="hljs-number">1</span>] - grid<br>        raw_true_wh = K.log(y_true[l][..., <span class="hljs-number">2</span>:<span class="hljs-number">4</span>] / anchors[anchor_mask[l]] * input_shape[::-<span class="hljs-number">1</span>])<br>        raw_true_wh = K.switch(object_mask, raw_true_wh, K.zeros_like(raw_true_wh)) <span class="hljs-comment"># avoid log(0)=-inf</span><br>        box_loss_scale = <span class="hljs-number">2</span> - y_true[l][...,<span class="hljs-number">2</span>:<span class="hljs-number">3</span>]*y_true[l][...,<span class="hljs-number">3</span>:<span class="hljs-number">4</span>]<br><br>        <span class="hljs-comment"># Find ignore mask, iterate over each of batch.</span><br>        ignore_mask = tf.TensorArray(K.dtype(y_true[<span class="hljs-number">0</span>]), size=<span class="hljs-number">1</span>, dynamic_size=<span class="hljs-literal">True</span>)<br>        object_mask_bool = K.cast(object_mask, <span class="hljs-string">&#x27;bool&#x27;</span>)<br><span class="hljs-comment"># loop_body计算batch_size内最大的IOU</span><br>        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loop_body</span>(<span class="hljs-params">b, ignore_mask</span>):</span><br><span class="hljs-comment"># tf.boolean_mask Apply boolean mask to tensor. Numpy equivalent is tensor[mask]. 根据y_true的置信度标识，来框定y_true的坐标系参数是否有效。</span><br>            true_box = tf.boolean_mask(y_true[l][b,...,<span class="hljs-number">0</span>:<span class="hljs-number">4</span>], object_mask_bool[b,...,<span class="hljs-number">0</span>])<br>            iou = box_iou(pred_box[b], true_box)<br>            best_iou = K.<span class="hljs-built_in">max</span>(iou, axis=-<span class="hljs-number">1</span>)<br>	<span class="hljs-comment">#当一张图片的最大IOU低于ignore_thresh，则认为图片内是没有目标</span><br>            ignore_mask = ignore_mask.write(b, K.cast(best_iou&lt;ignore_thresh, K.dtype(true_box)))<br>            <span class="hljs-keyword">return</span> b+<span class="hljs-number">1</span>, ignore_mask<br>_, ignore_mask = K.control_flow_ops.while_loop(<span class="hljs-keyword">lambda</span> b,*args: b&lt;m, loop_body, [<span class="hljs-number">0</span>, <br>ignore_mask])<br>        ignore_mask = ignore_mask.stack()<br>        ignore_mask = K.expand_dims(ignore_mask, -<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># K.binary_crossentropy is helpful to avoid exp overflow.</span><br>        xy_loss = object_mask * box_loss_scale * K.binary_crossentropy(raw_true_xy, raw_pred[...,<span class="hljs-number">0</span>:<span class="hljs-number">2</span>], f				rom_logits=<span class="hljs-literal">True</span>)<br>        wh_loss = object_mask * box_loss_scale * <span class="hljs-number">0.5</span> * K.square(raw_true_wh-raw_pred[...,<span class="hljs-number">2</span>:<span class="hljs-number">4</span>])<br>	<span class="hljs-comment"># 置信度</span><br>        confidence_loss = object_mask * K.binary_crossentropy(object_mask, raw_pred[...,<span class="hljs-number">4</span>:<span class="hljs-number">5</span>], from_logits=<span class="hljs-literal">True</span>)+ (<span class="hljs-number">1</span>-object_mask) * K.binary_crossentropy(object_mask, raw_pred[...,<span class="hljs-number">4</span>:<span class="hljs-number">5</span>], from_logits=<span class="hljs-literal">True</span>) * ignore_mask<br><span class="hljs-comment"># 分类</span><br>class_loss = object_mask * K.binary_crossentropy(true_class_probs, raw_pred[...,<span class="hljs-number">5</span>:], from_logits=<span class="hljs-literal">True</span>)<br><br>        xy_loss = K.<span class="hljs-built_in">sum</span>(xy_loss) / mf<br>        wh_loss = K.<span class="hljs-built_in">sum</span>(wh_loss) / mf<br>        confidence_loss = K.<span class="hljs-built_in">sum</span>(confidence_loss) / mf<br>        class_loss = K.<span class="hljs-built_in">sum</span>(class_loss) / mf<br>        loss += xy_loss + wh_loss + confidence_loss + class_loss<br>        <span class="hljs-keyword">if</span> print_loss:<br>loss = tf.Print(loss, [loss, xy_loss, wh_loss, confidence_loss, class_loss, K.<span class="hljs-built_in">sum</span>(ignore_mask)], message=<span class="hljs-string">&#x27;loss: &#x27;</span>)<br><span class="hljs-keyword">return</span> loss<br></code></pre></td></tr></table></figure>
<p>附录B<br>训练和检测都导入了yolo3.utils：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#yolo3.utils中是其他使用函数，主要用于keras-yolo数据增强的一些方法。</span><br><span class="hljs-string">&quot;&quot;&quot;Miscellaneous utility functions.&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> matplotlib.colors <span class="hljs-keyword">import</span> rgb_to_hsv, hsv_to_rgb<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compose</span>(<span class="hljs-params">*funcs</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Compose arbitrarily many functions, evaluated left to right.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Reference: https://mathieularose.com/function-composition-in-python/</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># return lambda x: reduce(lambda v, f: f(v), funcs, x)</span><br>    <span class="hljs-keyword">if</span> funcs:<br>        <span class="hljs-keyword">return</span> reduce(<span class="hljs-keyword">lambda</span> f, g: <span class="hljs-keyword">lambda</span> *a, **kw: g(f(*a, **kw)), funcs)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&#x27;Composition of empty sequence not supported.&#x27;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letterbox_image</span>(<span class="hljs-params">image, size</span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;resize image with unchanged aspect ratio using padding&#x27;&#x27;&#x27;</span><br>    iw, ih = image.size<br>    w, h = size<br>    scale = <span class="hljs-built_in">min</span>(w/iw, h/ih)<br>    nw = <span class="hljs-built_in">int</span>(iw*scale)<br>    nh = <span class="hljs-built_in">int</span>(ih*scale)<br><br>    image = image.resize((nw,nh), Image.BICUBIC)<br>    new_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, size, (<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>))<br>    new_image.paste(image, ((w-nw)//<span class="hljs-number">2</span>, (h-nh)//<span class="hljs-number">2</span>))<br>    <span class="hljs-keyword">return</span> new_image<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rand</span>(<span class="hljs-params">a=<span class="hljs-number">0</span>, b=<span class="hljs-number">1</span></span>):</span><br>    <span class="hljs-keyword">return</span> np.random.rand()*(b-a) + a<br><span class="hljs-comment">#在utils.py(get_random_data)函数中实现数据处理</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_random_data</span>(<span class="hljs-params">annotation_line, input_shape, random=<span class="hljs-literal">True</span>, max_boxes=<span class="hljs-number">20</span>, jitter=<span class="hljs-number">.3</span>, hue=<span class="hljs-number">.1</span>, sat=<span class="hljs-number">1.5</span>, val=<span class="hljs-number">1.5</span>, proc_img=<span class="hljs-literal">True</span></span>):</span><br>    <span class="hljs-string">&#x27;&#x27;&#x27;random preprocessing for real-time data augmentation&#x27;&#x27;&#x27;</span><br>    line = annotation_line.split()<br>    image = Image.<span class="hljs-built_in">open</span>(line[<span class="hljs-number">0</span>])<br>    iw, ih = image.size<br>    h, w = input_shape<br>    box = np.array([np.array(<span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>,box.split(<span class="hljs-string">&#x27;,&#x27;</span>)))) <span class="hljs-keyword">for</span> box <span class="hljs-keyword">in</span> line[<span class="hljs-number">1</span>:]])<br><span class="hljs-comment">#not random的实现</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> random:<br>        <span class="hljs-comment"># resize image</span><br>        <span class="hljs-comment">#缩放大小</span><br>        scale = <span class="hljs-built_in">min</span>(w/iw, h/ih)<br>        nw = <span class="hljs-built_in">int</span>(iw*scale)<br>        nh = <span class="hljs-built_in">int</span>(ih*scale)<br>        <span class="hljs-comment">#中心点</span><br>        dx = (w-nw)//<span class="hljs-number">2</span><br>        dy = (h-nh)//<span class="hljs-number">2</span><br>        image_data=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> proc_img:<br>            image = image.resize((nw,nh), Image.BICUBIC)<br>		   <span class="hljs-comment">#背景</span><br>            new_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (w,h), (<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>))<br>		   <span class="hljs-comment">#黏贴图pain</span><br>            new_image.paste(image, (dx, dy))<br>		   <span class="hljs-comment">#归一化</span><br>            image_data = np.array(new_image)/<span class="hljs-number">255.</span><br><br>        <span class="hljs-comment"># correct boxes</span><br>        box_data = np.zeros((max_boxes,<span class="hljs-number">5</span>))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(box)&gt;<span class="hljs-number">0</span>:<br>            np.random.shuffle(box)<br>		   <span class="hljs-comment"># 最大20个BOX。</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(box)&gt;max_boxes: box = box[:max_boxes]<br>		   <span class="hljs-comment">#根据缩放大小，生成新图中的BOX位置</span><br>            box[:, [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>]] = box[:, [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>]]*scale + dx<br>            box[:, [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]] = box[:, [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]]*scale + dy<br>            box_data[:<span class="hljs-built_in">len</span>(box)] = box<br><br>        <span class="hljs-keyword">return</span> image_data, box_data<br><br><span class="hljs-comment"># resize image</span><br><span class="hljs-comment"># 随机生成宽高比</span><br>new_ar = w/h * rand(<span class="hljs-number">1</span>-jitter,<span class="hljs-number">1</span>+jitter)/rand(<span class="hljs-number">1</span>-jitter,<span class="hljs-number">1</span>+jitter)<br><span class="hljs-comment"># 随机生成缩放比例。</span><br>scale = rand(<span class="hljs-number">.25</span>, <span class="hljs-number">2</span>)<br><span class="hljs-comment"># 生成新的高宽数据，可能放大2倍。</span><br>    <span class="hljs-keyword">if</span> new_ar &lt; <span class="hljs-number">1</span>:<br>        nh = <span class="hljs-built_in">int</span>(scale*h)<br>        nw = <span class="hljs-built_in">int</span>(nh*new_ar)<br>    <span class="hljs-keyword">else</span>:<br>        nw = <span class="hljs-built_in">int</span>(scale*w)<br>        nh = <span class="hljs-built_in">int</span>(nw/new_ar)<br>    image = image.resize((nw,nh), Image.BICUBIC)<br><br><span class="hljs-comment"># place image</span><br><span class="hljs-comment"># 随机水平位移</span><br>    dx = <span class="hljs-built_in">int</span>(rand(<span class="hljs-number">0</span>, w-nw))<br>    dy = <span class="hljs-built_in">int</span>(rand(<span class="hljs-number">0</span>, h-nh))<br>    new_image = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, (w,h), (<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>))<br>    new_image.paste(image, (dx, dy))<br>    image = new_image<br><br><span class="hljs-comment"># flip image or not</span><br><span class="hljs-comment"># 翻转</span><br>    flip = rand()&lt;<span class="hljs-number">.5</span><br>    <span class="hljs-keyword">if</span> flip: image = image.transpose(Image.FLIP_LEFT_RIGHT)<br><br><span class="hljs-comment"># distort image</span><br><span class="hljs-comment"># HSV抖动</span><br>    hue = rand(-hue, hue)<br>    sat = rand(<span class="hljs-number">1</span>, sat) <span class="hljs-keyword">if</span> rand()&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>/rand(<span class="hljs-number">1</span>, sat)<br>val = rand(<span class="hljs-number">1</span>, val) <span class="hljs-keyword">if</span> rand()&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>/rand(<span class="hljs-number">1</span>, val)<br><span class="hljs-comment"># 归一化处理</span><br><span class="hljs-comment"># 内部函数，通过公式转化。具体函数不介绍。</span><br>    x = rgb_to_hsv(np.array(image)/<span class="hljs-number">255.</span>)<br>    x[..., <span class="hljs-number">0</span>] += hue<br>    x[..., <span class="hljs-number">0</span>][x[..., <span class="hljs-number">0</span>]&gt;<span class="hljs-number">1</span>] -= <span class="hljs-number">1</span><br>    x[..., <span class="hljs-number">0</span>][x[..., <span class="hljs-number">0</span>]&lt;<span class="hljs-number">0</span>] += <span class="hljs-number">1</span><br>    x[..., <span class="hljs-number">1</span>] *= sat<br>x[..., <span class="hljs-number">2</span>] *= val<br><span class="hljs-comment"># 避免S/V CHANNEL越界</span><br>    x[x&gt;<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>    x[x&lt;<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>    image_data = hsv_to_rgb(x) <span class="hljs-comment"># numpy array, 0 to 1</span><br><br>    <span class="hljs-comment"># correct boxes</span><br>    box_data = np.zeros((max_boxes,<span class="hljs-number">5</span>))<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(box)&gt;<span class="hljs-number">0</span>:<br>        np.random.shuffle(box)<br>        box[:, [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>]] = box[:, [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>]]*nw/iw + dx<br>        box[:, [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]] = box[:, [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]]*nh/ih + dy<br>	        <span class="hljs-comment">### 左右翻转</span><br>        <span class="hljs-keyword">if</span> flip: box[:, [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>]] = w - box[:, [<span class="hljs-number">2</span>,<span class="hljs-number">0</span>]]<br>        <span class="hljs-comment">### 定义边界</span><br>        box[:, <span class="hljs-number">0</span>:<span class="hljs-number">2</span>][box[:, <span class="hljs-number">0</span>:<span class="hljs-number">2</span>]&lt;<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>        box[:, <span class="hljs-number">2</span>][box[:, <span class="hljs-number">2</span>]&gt;w] = w<br>        box[:, <span class="hljs-number">3</span>][box[:, <span class="hljs-number">3</span>]&gt;h] = h<br>        <span class="hljs-comment">### 计算新的长宽</span><br>        box_w = box[:, <span class="hljs-number">2</span>] - box[:, <span class="hljs-number">0</span>]<br>        box_h = box[:, <span class="hljs-number">3</span>] - box[:, <span class="hljs-number">1</span>]<br>        box = box[np.logical_and(box_w&gt;<span class="hljs-number">1</span>, box_h&gt;<span class="hljs-number">1</span>)] <span class="hljs-comment"># discard invalid box</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(box)&gt;max_boxes: box = box[:max_boxes]<br>        box_data[:<span class="hljs-built_in">len</span>(box)] = box<br>    <span class="hljs-keyword">return</span> image_data, box_data<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Computer-Version/">Computer Version</a>
                    
                      <a class="hover-with-bg" href="/categories/Computer-Version/Paper/">Paper</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CV/">CV</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/29/YOLO9000-Better-Faster-Stronger/">
                        <span class="hidden-mobile">YOLO9000: Better, Faster, Stronger</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@waline/client@0.14.8/dist/Waline.min.js', function () {
        new Waline({
          el: "#waline",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          serverURL: "http://gzzyyxh.cn",
          avatarCDN: "",
          avatarForce: true,
          requiredFields: [],
          emojiCDN: "",
          emojiMaps: {},
          anonymous: null,
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-svg.js" ></script>

  








  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
